<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="">
    <head>
    </head>
    <body>
        <h1>Feature Integration - Product Reviews</h1>
        <h2>Prerequisites</h2>
        <p>To prepare your project to work with Product Reviews:</p>
        <ol>
            <li>Require the Product Review modules in your <var>composer</var> by running
            <ul><li><var>composer require spryker/product-review</var></li><li><var>composer require spryker/product-review-collector</var></li><li><var>composer require spryker/product-review-gui</var></li></ul></li>
            <li>Install the new database tables by running <var>vendor/bin/console propel:diff</var>. Propel should generate a migration file with the changes.</li>
            <li>Run <var>vendor/bin/console propel:migrate</var> to apply the database changes.</li>
            <li>Generate ORM models by running <var>vendor/bin/console propel:model:build</var>.
            <p>This command will generate some new classes in your project under <var>\Orm\Zed\ProductReview\Persistence</var> namespace.
                    It is important to make sure that they extend the base classes from the Spryker core, e.g.:</p><ul><li><var>\Orm\Zed\ProductReview\Persistence\SpyProductReview</var> extends <var>\Spryker\Zed\ProductReview\Persistence\Propel\AbstractSpyProductReview</var></li><li><var>\Orm\Zed\ProductReview\Persistence\SpyProductReviewQuery</var> extends <var>\Spryker\Zed\ProductReview\Persistence\Propel\AbstractSpyProductReviewQuery</var></li></ul></li>
            <li>Run <var>vendor/bin/console transfer:generate</var> to generate the new transfer objects.</li>
            <li>
            Activate the product review collectors by adding the <var>ProductReviewCollectorSearchPlugin </var>and the <var>ProductAbstractReviewCollectorStoragePlugin </var>to the Storage and Search Collector plugin stack.
            <MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot>Example: collector plugin list extension</MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

    namespace Pyz\Zed\Collector;

    use Spryker\Zed\Collector\CollectorDependencyProvider as SprykerCollectorDependencyProvider;
    use Spryker\Zed\Kernel\Container;
    use Spryker\Zed\ProductReviewCollector\Communication\Plugin\ProductReviewCollectorSearchPlugin;
    use Spryker\Zed\ProductReviewCollector\Communication\Plugin\ProductAbstractReviewCollectorStoragePlugin;
    // ...

    class CollectorDependencyProvider extends SprykerCollectorDependencyProvider
    {
        /**
         * @param \Spryker\Zed\Kernel\Container $container
         *
         * @return \Spryker\Zed\Kernel\Container
         */
        public function provideBusinessLayerDependencies(Container $container)
        {
            // ...

            $container[static::SEARCH_PLUGINS] = function (Container $container) {
                return [
                    // ...
                    ProductReviewConfig::RESOURCE_TYPE_PRODUCT_REVIEW =&gt; new ProductReviewCollectorSearchPlugin(),
                ];
            };

            $container[static::STORAGE_PLUGINS] = function (Container $container) {
                return [
                    // ...
                    ProductReviewConfig::RESOURCE_TYPE_PRODUCT_ABSTRACT_REVIEW =&gt; new ProductAbstractReviewCollectorStoragePlugin(),
                ];
            };


            // ...
        }
    }</code></pre></MadCap:dropDownBody></MadCap:dropDown></li>
            <li>Run <var>vendor/bin/console setup:search</var> to set up Search before you run Search collectors.</li>
            <li>Make sure the new Zed user interface assets are built by running <var>npm run zed</var> (or antelope build zed for older versions).</li>
            <li>Update Zed’s navigation cache to show the new items for the Product Review management user interface by running <var>vendor/bin/console application:build-navigation-cache</var>.</li>
        </ol>
        <p>You should now be able to use the Zed API of Product Reviews to approve, reject and delete reviews, and the collectors should also be able to push approved reviews and ratings into Storage and Search.
        Check out our <a href="https://github.com/spryker/demoshop">Demoshop implementation</a> for frontend implementation example and idea.</p>
        <h2>Usage in Yves</h2>
        <h3>Submitting a Product Review</h3>
        <p>To store an already validated product review, populate a <var>\Generated\Shared\Transfer\ProductReviewTransfer</var> transfer object and send it to Zed by calling the <var>\Spryker\Client\ProductReview\ProductReviewClientInterface::submitCustomerReview</var> method.</p>
        <p>This action will create a new pending product review in your persistent storage. The saved product review will be exported to Search and Storage after it was approved on Zed UI.</p>
        <p>Make sure that the provided <var>rating</var> value does not exceed the <a href="product-review-feature-configuration.htm#configure-maximum-rating">configured maximum rating</a> limit.</p>      Example of how to store a validated customer review:
			<pre><code class="language-PHP line-numbers">&lt;?php

    /**
     * @method \Pyz\Yves\ProductReview\ProductReviewFactory getFactory()
     */
    class SubmitController extends Pyz\Yves\Application\Controller\AbstractController
    {
        /**
         * @param \Symfony\Component\HttpFoundation\Request $request
         */
        public function submitAction(Request $request)
        {
            $customerReference = $this-&gt;getFactory()-&gt;getCustomerClient()-&gt;getCustomer()-&gt;getCustomerReference();

            $this-&gt;getFactory()-&gt;getProductReviewClient()-&gt;submitCustomerReview(
                (new ProductReviewRequestTransfer())
                        -&gt;setCustomerReference($customerReference)
                        -&gt;setLocaleName($this-&gt;getLocale())
                        -&gt;setIdProductAbstract($request-&gt;attributes-&gt;get('idProductAbstract'))
                        -&gt;setSummary($request-&gt;attributes-&gt;get('summary'))
                        -&gt;setDescription($request-&gt;attributes-&gt;get('description'))
                        -&gt;setRating($request-&gt;attributes-&gt;get('rating'))
                        -&gt;setNickname($request-&gt;attributes-&gt;get('nickname'))
            );
        }
    }
            </code></pre><h3>Displaying an Average Rating</h3><p>To display the average rating stored in Storage, you will need to use <var>spyProductAbstractReview</var> and <var>spyProductAbstractReviewMaximumRating</var> twig extensions shipped by <var>ProductReview</var> module.</p><p><var>spyProductAbstractReview</var> twig extension takes product abstract ID as first argument and injects the corresponding <var>ProductAbstractReviewTransfer</var> transfer object into the twig template provided as the second argument.</p><p><var>spyProductAbstractReviewMaximumRating</var> twig extension allows you to retrieve the <a href="product-review-feature-configuration.htm#configure-maximum-rating">configured maximum rating</a> on demand.</p><p>To register these plugins, you need to add <var>ProductAbstractReviewTwigServiceProvider</var> service provider to your <var>\Pyz\Yves\Application\YvesBootstrap.php</var>.</p>Example of how to register twig extensions:<pre><code class="language-PHP line-numbers">&lt;?php
    namespace Pyz\Yves\Application;

    use Spryker\Yves\ProductReview\Plugin\Provider\ProductAbstractReviewTwigServiceProvider;

    class YvesBootstrap
    {
        /**
         * @return void
         */
        protected function registerServiceProviders()
        {
            // ...
            $this-&gt;application-&gt;register(new ProductAbstractReviewTwigServiceProvider());
        }

    }
                    </code></pre><p>Now you will be able to call the registered <var>spyProductAbstractReview</var> and <var>spyProductAbstractReviewMaximumRating</var> twig extensions in your twig templates.</p>Below is the example <var>spyProductAbstractReview</var> call.<p>@ProductReview/index/index.twig:</p><pre><code class="language-html line-numbers">
&lt;div&gt;Product name: {{product.name}}&lt;/div&gt;
{{ spyProductAbstractReview(product.idProductAbstract, '@ProductReview/partials/average-rating.twig') }}
                </code></pre><p>The <var>spyProductAbstractReview</var> twig extension will render the template provided as a second argument and inject the <var>productAbstractReviewTransfer</var> variable.</p>Below is the example average-rating.twig implementation.<p>@ProductReview/partials/average-rating.twig:</p><pre><code class="language-html line-numbers">
{% block content %}
    {% if productAbstractReviewTransfer %}
        Average product rating is {{ productAbstractReviewTransfer.averageRating }} out of {{ spyProductAbstractReviewMaximumRating() }}
    {% endif %}
{% endblock %}
            </code></pre><h3>Displaying Reviews and Rating Summary</h3><p>To display previously posted and already approved reviews from Search, you will need to call <var>\Spryker\Client\ProductReview\ProductReviewClientInterface::findProductReviewsInSearch</var> method.</p><p>To alter the retrieved number of product reviews per page, change the <a href="product-review-feature-configuration.htm#configure-elements-per-page">Client configuration</a>.</p>Example of product review retrieval:<pre><code class="language-PHP line-numbers">
namespace Pyz\Yves\ProductReview\Controller;

use Generated\Shared\Transfer\ProductReviewSearchRequestTransfer;
use Pyz\Yves\Application\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;

/**
 * @method \Spryker\Client\ProductReview\ProductReviewClientInterface getClient()
 */
class IndexController extends AbstractController
{

    /**
     * @param \Symfony\Component\HttpFoundation\Request $request
     *
     * @return array
     */
    public function indexAction(Request $request)
    {
        $productReviews = $this-&gt;getClient()-&gt;findProductReviewsInSearch(
            (new ProductReviewSearchRequestTransfer())
                -&gt;setIdProductAbstract($request-&gt;attributes-&gt;get('idProductAbstract'));
                -&gt;setRequestParams($request-&gt;query-&gt;all())
        );

        return [
            'productReviews' =&gt; $productReviews['productReviews'],
            'pagination' =&gt; $productReviews['pagination'],
            'ratingAggregation' =&gt; $productReviews['ratingAggregation'],
        ];
    }

}

            </code></pre><p>&#160;</p><p><![CDATA[
		
		]]><i>Last review date: Aug. 28, 2017 </i><MadCap:conditionalText MadCap:conditions="General.Hidden Comment"><i>by Karoly Gerner</i></MadCap:conditionalText></p></body>
</html>