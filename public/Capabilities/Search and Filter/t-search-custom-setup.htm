<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="Spryker.B2B,Spryker.B2C">
    <head>
    </head>
    <body>
        <h1>Tutorial - Search Custom Setup <img src="../../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../../Resources/Images/shoptype/B2C_Shop.png" /></h1>
        <p MadCap:conditions="General.Hidden Comment">used to be: http://spryker.github.io/tutorials/yves/search-custom-setup/</p>
        <p>There might be instances when you need to go beyond product search or you have very specific requirements regarding search. You’re not tied to the basic mapping that ships with Spryker. You can easily roll your own and set up custom analyzer very easily. The underlaying library that gets used by Spryker is called <a href="https://github.com/ruflin/Elastica" target="_blank" title="Elastica " alt="Elastica ">Elastica</a> and you can use it to set up custom mapping and analyzers as you like.</p>
        <h2>Custom Analyzers</h2>
        <p>The Elasticsearch indexes get installed during installation of collectors. To add custom analyzers you will need to override <var>Spryker\Zed\Collector\Business\Internal\InstallElasticsearch</var>. Let’s create a quick example setting up a German analyzer.</p>
        <p>Create a file called <var>InstallElasticsearch.php</var> inside the <var>Collector</var> module on the project level</p><pre><code class="language-PHP line-numbers">touch src/Pyz/Zed/Collector/Business/Internal/InstallElasticsearch.php</code></pre>
        <p>Override the <var>createIndex()</var> method and provide your custom analyzer setup along with index creation.</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Collector\Business\Internal;

use Spryker\Zed\Collector\Business\Internal as SprykerInstallElasticsearch;

class InstallElasticsearch extends SprykerInstallElasticsearch 
{
    
    protected createIndex() {
        $index = $this-&gt;client-&gt;getIndex($this-&gt;indexName);

        if (!$index-&gt;exists()) {
            $index-&gt;create(
                [
                    'number_of_shards' =&gt; 4,
                    'number_of_replicas' =&gt; 1,
                    'analysis' =&gt; [
                        'filter' =&gt; [
                            'german_stop' =&gt; [
                                'type' =&gt; 'stop',
                                'stopwords' =&gt; '_german_',
                            ],
                            'german_stemmer' =&gt; [
                                'type' =&gt; 'stemmer',
                                'language' =&gt; 'light_german',
                            ],
                        ],
                    ],
                    'analyzer' =&gt; [
                        'german' =&gt; [
                            'tokenizer' =&gt; 'standard',
                            'filter' =&gt; [
                                'lowecase',
                                'german_stop',
                                'german_normalization',
                                'german_stemmer',
                            ]
                        ],
                    ],
                ]
            );
        }
    }

}</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <p class="note">The <var>$index</var> variable holds an instance of <var>Elastica\Index</var>. The array that is passed to the <var>create()</var> method of that instance can contain any Elasticsearch setting. As you can see from the example above it gets used to set up the number of replicas and shards as well.</p>
        <p>Elasticsearch provides analyzers for a lot of languages. Detailed information on how to properly set up analyzers can be found in the documentation at <a href="https://www.elastic.io/" target="_blank" title="Elastic" alt="Elastic">http://www.elastic.io/</a></p>
        <h2>Custom Mapping</h2>
        <p>If you have diverging requirements for product search than what Spryker is offering, you might want to set up a custom mapping. Either you have different requirements regarding aggregations/facets or you want a more fine grained document with multiple fields for each product attribute. It’s easy to override the default mapping and create your own.</p>
        <p>The default mapping is defined in <var>Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch</var> and you will have to extend this class on project level.</p>
        <p>Create a file called <var>InstallProductSearch.php</var> inside the <var>ProductSearch</var> module on project level</p><pre><code class="language-PHP line-numbers">touch src/Pyz/Zed/ProductSearch/Business/Internal/InstallProductSearch.php</code></pre>
        <p>Override <var>createProductType()</var> method and install your custom mapping</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php
namespace Pyz\Zed\ProductSearch\Business\Internal;

use Elastica\Index;
use Elastica\Type\Mapping;
use Elastica\Type;
use Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch as SprykerInstallProductSearch;

class InstallProductSearch extends SprykerInstallProductSearch
{

    /**
     * @throws \RuntimeException
     *
     * @param \Elastica\Index $index
     *
     * @return void
     */
    protected function createProductType(Index $index)
    {
        $index = $this-&gt;client-&gt;getIndex($this-&gt;indexName);

        if (!$index-&gt;exists()) {
            throw new \RuntimeException(sprintf('Index %s is missing', $this-&gt;indexName));
        }

        $type = $index-&gt;getType($this-&gt;indexType);

        if ($type-&gt;exists() === true) {
            return;
        }

        $mapping = new Mapping($type);
        $mapping-&gt;setProperties([
            'title' =&gt; [
                'type' =&gt; 'string',
                'analyzer' =&gt; 'german',
            ],
            'description' =&gt; [
                'type' =&gt; 'string',
                'analyzer' =&gt; 'german',
            ],
            'price' =&gt; [
                'type' =&gt; 'integer',
            ],
        ]);
        $mapping-&gt;send();
    }</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <h2>Extend Existing Mapping</h2>
        <p>If you want to use the existing mapping that comes with Spryker but want to add additional fields, or change properties for existing fields, you will also need to override <var>Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch</var>. Follow the steps in the previous paragraph and add the file to your project level implementation.</p>
        <p>Instead of replacing the implementation of <var>createProductType()</var> we will extend it. Unfortunately there’s a pitfall here. Elasticseach doesn’t allow to alter a mapping since that would lead to an inconsistent state of documents that are already indexed. However, there’s a workaround to still achieve out goal. We can load the currently installed mapping, delete the document type (which will also remove all documents of that type from the index) and then reinstall the mapping.</p>
        <p>Here’s a simple example that uses our previously defined <var>german</var> analyzer for the <var>full-text</var> field</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\ProductSearch\Business\Internal;

use Elastica\Index;
use Elastica\Type\Mapping;
use Elastica\Type;
use Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch as SprykerInstallProductSearch;

class InstallProductSearch extends SprykerInstallProductSearch
{

    /**
     * @param \Elastica\Index $index
     *
     * @return void
     */
    protected function createProductType(Index $index)
    {
        parent::createProductType($index);

        $type = $index-&gt;getType($this-&gt;indexType);
        $mappingProperties = $this-&gt;getExistingMappingProperties($type);

        $mappingProperties['full-text'] = [
            'type' =&gt; 'string',
            'analyzer' =&gt; 'german',
        ];

        $type-&gt;delete();

        $mapping = new Mapping($type);
        $mapping-&gt;setProperties($mappingProperties);
        $mapping-&gt;send();
    }

    /**
     * @param Elastica\Type $type
     *
     * @return array
     */
    protected function getExistingMappingProperties(Type $type)
    {
        $mapping = $type-&gt;getMapping();

        return $mapping[this-&gt;indexType]['properties'];
    }

}</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
    </body>
</html>