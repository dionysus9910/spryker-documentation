<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="Spryker.B2B,Spryker.B2C,Spryker.MultiCurrency">
    <head>
    </head>
    <body>
        <h1>Multi-Currency - Search <img src="../../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../../Resources/Images/shoptype/B2C_Shop.png" /></h1>
        <p>
            <MadCap:popup>
                <MadCap:popupHead>MC</MadCap:popupHead>
                <MadCap:popupBody>Multi-currency</MadCap:popupBody>
            </MadCap:popup>
        </p>
        <p>
            If you don't have the multi-currency feature in you current project yet and want to migrate, you have to follow certain steps to migrate your system.

            First <a href="https://documentation.spryker.com/module_migration_guides/mg-price.htm">migrate Price</a> and <a href="https://documentation.spryker.com/module_migration_guides/mg-multi-currency.htm">modules related to multi-currency</a> before proceeding with the search for multi-currency.

            </p>
        <p>We have changed the way price types are stored in elastic search. Previously, under the prices field there was a price list stored by price type,
            for example,
<pre><code class="language-PHP line-numbers">
 prices : {
     DEFAULT : 100,
     ORIGINAL: 150
 }
            </code></pre>.
          In the current multi-currency feature we store prices grouped by price mode and currency, so prices are as follows now: </p><pre><code class="language-PHP line-numbers">{
 EUR : {
     GROSS_MODE : {
         DEFAULT : 100,
         ORIGINAL: 150
      },
      NET_MODE : {
          DEFAULT : 100,
          ORIGINAL: 150
      }
   }
}
</code></pre>
        <p>
            The "price" field has the same structure, but value has a different meaning. This value now stores a default price.
            Default price is the price having the default price type, currency and price mode which is defined in the price configuration.

            The price is stored grouped in elastic search, but before returning it for the view, we format it and return prices based on the currently selected currency, price mode and price type.

            So the result structure/schema you get from search client will be the same as before multi-currency change:

            <pre><code class="language-PHP line-numbers">
 prices : {
     DEFAULT : 100,
     ORIGINAL: 150
 }
            </code></pre>

            Value will be adjusted according to the customer state (currency, price mode and price type).

            Because of this you have to decorate <var>RawCatalogSearchResultFormatterPlugin</var> with <var>\Spryker\Client\CatalogPriceProductConnector\Plugin\CurrencyAwareCatalogSearchResultFormatterPlugin</var> in modules using it.
			For <var>\Pyz\Client\Catalog\CatalogDependencyProvider</var>: 
				<MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot>Click here to expand the code sample</MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><pre><code class="language-PHP line-numbers">
namespace Pyz\Client\Catalog;

class CatalogDependencyProvider extends SprykerCatalogDependencyProvider
{
    /**
    * @return \Spryker\Client\Search\Dependency\Plugin\ResultFormatterPluginInterface[]
    */
   protected function createCatalogSearchResultFormatterPlugins()
   {
       return [
           new FacetResultFormatterPlugin(),
           new SortedResultFormatterPlugin(),
           new PaginatedResultFormatterPlugin(),
           new CurrencyAwareCatalogSearchResultFormatterPlugin( //raw result decoration with multi currency logic
               new RawCatalogSearchResultFormatterPlugin()
           ),
           new SpellingSuggestionResultFormatterPlugin(),
       ];
   }

    /**
     * @return \Spryker\Client\Search\Dependency\Plugin\ResultFormatterPluginInterface[]
     */
    protected function createSuggestionResultFormatterPlugins()
    {
        return [
            new CompletionResultFormatterPlugin(),
            new CurrencyAwareSuggestionByTypeResultFormatter(  //suggestion result decoration with multi currency logic
                new SuggestionByTypeResultFormatterPlugin()
            ),
        ];
    }

    /**
    * @param \Spryker\Client\Kernel\Container $container
    *
    * @return \Spryker\Client\Kernel\Container
    */
   protected function provideFeatureProductsResultFormatterPlugins(Container$container)
   {
       $container[self::FEATURED_PRODUCTS_RESULT_FORMATTER_PLUGINS] = function () {
           return [
               new CurrencyAwareCatalogSearchResultFormatterPlugin( //raw result decoration with multi currency logic
                   new RawCatalogSearchResultFormatterPlugin()
               ),
           ];
       };

       return $container;
   }
}
</code></pre></MadCap:dropDownBody></MadCap:dropDown>

For <var>\Pyz\Client\ProductNew\ProductNewDependencyProvider</var>:

<pre><code class="language-PHP line-numbers">
namespace Pyz\Client\ProductNew;

class ProductNewDependencyProvider extends AbstractDependencyProvider
{
    /**
   * @param \Spryker\Client\Kernel\Container $container
   *
   * @return \Spryker\Client\Kernel\Container
   */
  protected function addNewProductsResultFormatterPlugins(Container$container)
  {
      $container[self::NEW_PRODUCTS_RESULT_FORMATTER_PLUGINS] = function () {
          return [
              new FacetResultFormatterPlugin(),
              new SortedResultFormatterPlugin(),
              new PaginatedResultFormatterPlugin(),
              new CurrencyAwareCatalogSearchResultFormatterPlugin( /raw result decoration with multi currency logic
                  new RawCatalogSearchResultFormatterPlugin()
              ),
          ];
      };

      return $container;
  }
}

</code></pre>

For <var>\Pyz\Client\ProductSale\ProductSaleDependencyProvider</var>:

<pre><code class="language-PHP line-numbers">
namespace Pyz\Client\ProductSale;

class ProductSaleDependencyProvider extends AbstractDependencyProvider
{
    /**
     * @param \Spryker\Client\Kernel\Container $container
     *
     * @return \Spryker\Client\Kernel\Container
     */
    protected function addSaleSearchResultFormatterPlugins(Container$container)
    {
        $container[self::SALE_SEARCH_RESULT_FORMATTER_PLUGINS] = function () {
            return [
                new FacetResultFormatterPlugin(),
                new SortedResultFormatterPlugin(),
                new PaginatedResultFormatterPlugin(),
                new CurrencyAwareCatalogSearchResultFormatterPlugin( /raw result decoration with multi currency logic
                    new RawCatalogSearchResultFormatterPlugin()
                ),
            ];
        };

        return $container;
    }
}
            </code></pre>

       You also have to update the price expander to export grouped prices. To do this, change <var>\Pyz\Zed\ProductSearch\Business\Map\Expander\PriceExpander</var> class:
</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click here to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">
namespace Pyz\Zed\ProductSearch\Business\Map\Expander;

use Spryker\Client\CatalogPriceProductConnector\CatalogPriceProductConnectorClientInterface;

class PriceExpander implements ProductPageMapExpanderInterface
{
    /**
 * @var string
 */
protected static $netPriceModeIdentifier;

/**
 * @var string
 */
protected static $grossPriceModeIdentifier;

/**
 * @var \Spryker\Zed\PriceProduct\Business\PriceProductFacadeInterface
 */
protected $priceProductFacade;

/**
 * @var \Spryker\Client\CatalogPriceProductConnector\CatalogPriceProductConnectorClientInterface
 */
protected $catalogPriceProductConnectorClient;

/**
* @param \Spryker\Zed\PriceProduct\Business\PriceProductFacadeInterface $priceProductFacade
* @param \Spryker\Client\CatalogPriceProductConnector\CatalogPriceProductConnectorClientInterface $catalogPriceProductConnectorClient
*/
public function __construct(PriceProductFacadeInterface $priceProductFacade,  CatalogPriceProductConnectorClientInterface $catalogPriceProductConnectorClient)
{
   $this-&gt;priceProductFacade = $priceProductFacade;
   $this-&gt;catalogPriceProductConnectorClient = $catalogPriceProductConnectorClient;
}

/**
* @param \Generated\Shared\Transfer\PageMapTransfer $pageMapTransfer
* @param \Spryker\Zed\Search\Business\Model\Elasticsearch\DataMapper\PageMapBuilderInterface $pageMapBuilder
* @param array $productData
* @param \Generated\Shared\Transfer\LocaleTransfer $localeTransfer
*
* @return \Generated\Shared\Transfer\PageMapTransfer
*/
public function expandProductPageMap(
   PageMapTransfer $pageMapTransfer,
   PageMapBuilderInterface $pageMapBuilder,
   array $productData,
   LocaleTransfer $localeTransfer
) {

   $price = $this-&gt;priceProductFacade-&gt;getPriceBySku($productData['abstract_sku']);

   $pageMapBuilder
       -&gt;addSearchResultData($pageMapTransfer, 'price', $price)
       -&gt;addIntegerSort($pageMapTransfer, 'price', $price)
       -&gt;addIntegerFacet($pageMapTransfer, 'price', $price);

   $this-&gt;setPricesByType($pageMapBuilder, $pageMapTransfer, $productData);

   return $pageMapTransfer;
}

   /**
    * @param \Spryker\Zed\Search\Business\Model\Elasticsearch\DataMapper\PageMapBuilderInterface $pageMapBuilder
    * @param \Generated\Shared\Transfer\PageMapTransfer $pageMapTransfer
    * @param array $productData
    *
    * @return void
    */
   protected function setPricesByType(
       PageMapBuilderInterface $pageMapBuilder,
       PageMapTransfer $pageMapTransfer,
       array $productData
   ) {

       $pricesGrouped = $this-&gt;priceProductFacade-&gt;findPricesBySkuGrouped($productData['abstract_sku']);

       foreach ($pricesGrouped as $currencyIsoCode =&gt; $pricesByPriceMode) {
           foreach ($pricesByPriceMode as $priceMode =&gt; $pricesByType) {
               foreach ($pricesByType as $priceType =&gt; $price) {
                   $facetName = $this-&gt;catalogPriceProductConnectorClient-&gt;buildPricedIdentifierFor($priceType, $currencyIsoCode, $priceMode);
                   $pageMapBuilder-&gt;addIntegerFacet($pageMapTransfer, $facetName, $price);
                   $pageMapBuilder-&gt;addIntegerSort($pageMapTransfer, $facetName, $price);
               }
           }
       }

       $pageMapBuilder-&gt;addSearchResultData($pageMapTransfer, 'prices', $pricesGrouped);
   }
}
			</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>

Inject a new dependency:
		<MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot>Click here to expand the code sample</MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><pre><code class="language-PHP line-numbers">
namespace Pyz\Zed\ProductSearch;

class ProductSearchDependencyProvider extends SprykerProductSearchDependencyProvider
{
   const CLIENT_PRICE_PRODUCT_CONNECTOR_CLIENT = 'client price product connector client';

   /**
    * @param \Spryker\Zed\Kernel\Container $container
    *
    * @return \Spryker\Zed\Kernel\Container
    */
    public function provideBusinessLayerDependencies(Container $container)
    {
       $this-&gt;provideCatalogPriceProductConnectorClient($container);
    }

    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Kernel\Container
     */
    protected function provideCatalogPriceProductConnectorClient(Container $container)
    {
        $container[static::CLIENT_PRICE_PRODUCT_CONNECTOR_CLIENT] = function (Container $container) {
            return $container-&gt;getLocator()-&gt;catalogPriceProductConnector()-&gt;client();
        };

        return $container;
    }
}
</code></pre><pre><code class="language-PHP line-numbers">
&lt;?php
namespace Pyz\Zed\ProductSearch\Business;

use Pyz\Zed\ProductSearch\Business\Map\Expander\PriceExpander;

class ProductSearchBusinessFactory extends SprykerProductSearchBusinessFactory
{
  /**
   *  @return \Pyz\Zed\ProductSearch\Business\Map\Expander\ProductPageMapExpanderInterface
   */
  protected function createPriceExpander()
  {
      return new PriceExpander($this-&gt;getPriceProductFacade(), $this-&gt;getCatalogPriceProductConnectorClient());
  }

  /**
   * @return \Spryker\Client\CatalogPriceProductConnector\CatalogPriceProductConnectorClientInterface
   */
  protected function getCatalogPriceProductConnectorClient()
  {
      return $this-&gt;getProvidedDependency(ProductSearchDependencyProvider::CLIENT_PRICE_PRODUCT_CONNECTOR_CLIENT);
  }
}
		</code></pre></MadCap:dropDownBody></MadCap:dropDown>


It is also needed to configure prices for catalog search in <var>\Pyz\Client\Catalog\Plugin\Config\CatalogSearchConfigBuilder</var>:
		<MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot>Click here to expand the code sample</MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><pre><code class="language-PHP line-numbers">
namespace Pyz\Client\Catalog\Plugin\Config;

class CatalogSearchConfigBuilder extends AbstractPlugin implements SearchConfigBuilderInterface
{
    /**
     * @param \Spryker\Client\Search\Dependency\Plugin\FacetConfigBuilderInterface $facetConfigBuilder
     *
     * @return $this
     */
    protected function addPriceFacet(FacetConfigBuilderInterface $facetConfigBuilder)
    {
        $priceIdentifier = $this-&gt;getFactory()
           -&gt;getCatalogPriceProductConnectorClient()
           -&gt;buildPriceIdentifierForCurrentCurrency(); //new way of exporting prices to elasticsearch

       $priceFacet = (new FacetConfigTransfer())
           -&gt;setName($priceIdentifier)
           -&gt;setParameterName('price')
           -&gt;setFieldName(PageIndexMap::INTEGER_FACET)
           -&gt;setType(SearchConfig::FACET_TYPE_PRICE_RANGE);

       $facetConfigBuilder-&gt;addFacet($priceFacet);

        return $this;
    }

    /**
     * @param \Spryker\Client\Search\Dependency\Plugin\SortConfigBuilderInterface $sortConfigBuilder
     *
     * @return $this
     */
    protected function addAscendingPriceSort(SortConfigBuilderInterface $sortConfigBuilder)
    {
        $priceIdentifier = $this-&gt;getFactory()
            -&gt;getCatalogPriceProductConnectorClient()
            -&gt;buildPriceIdentifierForCurrentCurrency();

        $priceSortConfig = (new SortConfigTransfer())
            -&gt;setName($priceIdentifier)
            -&gt;setParameterName('price_asc')
            -&gt;setFieldName(PageIndexMap::INTEGER_SORT);

        $sortConfigBuilder-&gt;addSort($priceSortConfig);

        return $this;
    }

    /**
     * @param \Spryker\Client\Search\Dependency\Plugin\SortConfigBuilderInterface $sortConfigBuilder
     *
     * @return $this
     */
    protected function addDescendingPriceSort(SortConfigBuilderInterface $sortConfigBuilder)
    {
        $priceIdentifier = $this-&gt;getFactory()
            -&gt;getCatalogPriceProductConnectorClient()
            -&gt;buildPriceIdentifierForCurrentCurrency();

        $priceSortConfig = (new SortConfigTransfer())
            -&gt;setName($priceIdentifier)
            -&gt;setParameterName('price_desc')
            -&gt;setFieldName(PageIndexMap::INTEGER_SORT)
            -&gt;setIsDescending(true);

        $sortConfigBuilder-&gt;addSort($priceSortConfig);

        return $this;
    }
}
			</code></pre></MadCap:dropDownBody></MadCap:dropDown>

Inject a new dependency:

<pre><code class="language-PHP line-numbers">
namespace Pyz\Client\Catalog;

class CatalogDependencyProvider extends SprykerCatalogDependencyProvider
{
    const CLIENT_PRICE_PRODUCT_CONNECTOR_CLIENT = 'client price product connector client';

    /**
     * @param \Spryker\Client\Kernel\Container $container
     *
     * @return \Spryker\Client\Kernel\Container
     */
    public function provideServiceLayerDependencies(Container $container)
    {
        $container = $this-&gt;addCatalogPriceProductConnectorClient($container);
    }

    /**
     * @param \Spryker\Client\Kernel\Container $container
     *
     * @return \Spryker\Client\Kernel\Container
     */
    protected function addCatalogPriceProductConnectorClient(Container $container)
    {
        $container[static::CLIENT_PRICE_PRODUCT_CONNECTOR_CLIENT] = function (Container $container) {
            return $container-&gt;getLocator()-&gt;catalogPriceProductConnector()-&gt;client();
        };

        return $container;
    }
}
</code></pre>

Create a factory method for the new dependency:

<pre><code class="language-PHP line-numbers">
namespace Pyz\Client\Catalog;

class CatalogFactory extends SprykerCatalogFactory
{
      /**
       * @return \Spryker\Client\CatalogPriceProductConnector\CatalogPriceProductConnectorClientInterface
       */
      public function getCatalogPriceProductConnectorClient()
      {
          return $this-&gt;getProvidedDependency(CatalogDependencyProvider::CLIENT_PRICE_PRODUCT_CONNECTOR_CLIENT);
      }
}
</code></pre>

After these changes you should be able to see prices based on the selected price mode and currency.
      <p>&#160;</p><p><b>See also:</b></p><ul><li><a href="http://documentation.spryker.com/module_migration_guides/mg-price.htm">Migration Guide - Price</a></li><li><a href="http://documentation.spryker.com/module_migration_guides/mg-multi-currency.htm">Migration Guide - Multi-currency</a></li></ul><p>&#160;</p><p><i>Last review date: Nov 22nd, 2017 </i><MadCap:conditionalText MadCap:conditions="General.Hidden Comment"><i>by Aurimas Ličkus </i></MadCap:conditionalText></p><p></p></body>
</html>