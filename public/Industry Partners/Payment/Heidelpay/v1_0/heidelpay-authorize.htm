<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:conditions="Spryker.DemoShop,Spryker.B2C" description="Integrate Paypal Authorize payment through Hedelpay into Spryker Legacy Demoshop.">
    <head><title>Heidelpay Partner Integration - Paypal Authorize | Spryker</title>
        <meta name="description" content="Integrate Paypal Authorize payment through Heidelpay into Spryker Legacy Demoshop" />
    </head>
    <body>
        <h1>Heidelpay - Paypal Authorize <img src="../../../../Resources/Images/shoptype/B2C_Shop.png" /> <img src="../../../../Resources/Images/shoptype/Demoshop.png" /></h1>
        <h3>Setup</h3>
        <p>The following configuration should be made after Heidelpay has been <a href="heidelpay-installation.htm">installed</a> and <a href="heidelpay-integration.htm">integrated</a>.</p>
        <h4>Configuration</h4>
        <p>Example (for testing only):</p><pre><code class="language-php">$config[HeidelpayConstants::CONFIG_HEIDELPAY_TRANSACTION_CHANNEL_PAYPAL] = '31HA07BC8142C5A171749A60D979B6E4';</code></pre>
        <p><sub>This value should be taken from HEIDELPAY</sub>
        </p>
        <h4>Checkout Payment Step Display</h4>
        <p>Displays payment method name with radio button. No extra input fields are required.</p>
        <h4>Payment Step Submitting</h4>
        <p>No extra actions needed, quote is filled with payment method selection by default.</p>
        <h3>Workflow</h3>
        <h4>Summary Review and Order
    Submitting</h4>
        <p><b>On "save order" event</b> save Heidelpay payment
    per order and items, as usual.</p>
        <p><b>When state machine is initialized</b>, a "send
    authorize request" event will trigger the authorize request. In case of success, payment system will
    return a redirect URL to customer, where the payment can be completed. Request and response will be
    fully persisted in the database (<var>spy_payment_heidelpay_transaction_log</var>).&#160;</p>
        <p><b>On "post save hook" event</b>, we check in
    the transaction log table if the authorize request was sent successfully and if so, we set external
    redirect response (URL is obtained from the previous step) and redirect the customer to Paypal website,
    where customer confirms the payment. <br /> Below is the code sample from <var>HeidelpayPostSavePlugin</var>:</p><pre><code class="language-php line-numbers">
/**
 * @method \SprykerEco\Zed\Heidelpay\Business\HeidelpayFacadeInterface getFacade()
 * @method \SprykerEco\Zed\Heidelpay\Business\HeidelpayBusinessFactory getFactory()
 */
class HeidelpayPostSavePlugin extends BaseAbstractPlugin implements CheckoutPostCheckPluginInterface
{
   /**
	* @param \Generated\Shared\Transfer\QuoteTransfer $quoteTransfer
	* @param \Generated\Shared\Transfer\CheckoutResponseTransfer $checkoutResponseTransfer
	*
	* @return void
	*/
   public function execute(QuoteTransfer $quoteTransfer, CheckoutResponseTransfer $checkoutResponseTransfer)
   {
	  $this-&gt;getFacade()-&gt;postSaveHook($quoteTransfer, $checkoutResponseTransfer);
   }</code></pre>
        <p><u style="font-weight: bold; text-decoration: none;">On payment confirmation</u>, the response is sent to Heidelpay
    and Heidelpay makes an asynchronous POST request to the shop's <var>CONFIG_HEIDELPAY_PAYMENT_RESPONSE_URL</var>
    URL (Yves), with the result of payment (see <var>HeidelpayController::paymentAction()</var>). This is called "external response transaction", and its result will be persisted in
    <var>spy_payment_heidelpay_transaction_log</var> as usual.</p>
        <p> The most important data here is the payment reference ID which can be used for further transactions like <var>capture/cancel/etc</var>.</p>
        <p>In the response Heidelpay expects an URL string which defines where customer has to be redirected. In case if customer successfully confirmed payment, it should be a link to checkout order success step, in case of failure - checkout payment failed action with error code (see <var>HeidelpayController::paymentFailedAction()</var> and <a href="heidelpay-error-workflow.htm">Heidelpay - Workflow for Errors</a> section). Heidelpay
    redirects customer to the given URL and the payment process is finished.&#160;</p>
        <p><b>Capture the money</b> - later on, when the item is shipped to the customer, it is time to call "capture" command of the state machine to capture the money
    from the customer's account. It is done in CapturePlugin of the OMS command. In the provided basic order of state machine for Paypal authorize method, the command will be executed automatically, when order is manually moved into the "shipped" state. Now the order can be considered as "paid".
</p>
        <p>&#160;</p>
        <p><b>See also:</b>
        </p>
        <ul>
            <li><a href="../heidelpay.htm">Get a general idea about Heidelpay</a>
            </li>
            <li><a href="heidelpay-installation.htm">Install Heidelpay</a>
            </li>
            <li><a href="heidelpay-integration.htm">Integrate Heidelpay</a>
            </li>
            <li><a href="heidelpay-credit-card.htm">Configure Credit Card Secure for Heidelpay
</a>
            </li>
            <li><a href="heidelpay-ideal.htm">Configure iDeal for Hedelpay
</a>
            </li>
            <li><a href="heidelpay-paypal-debit.htm">Check Paypal Debit Workflow for Heidelpay
</a>
            </li>
            <li><a href="heidelpay-sofort.htm">Configure Sofort payment for Heidelay
</a>
            </li>
            <li><a href="heidelpay-easy-credit.htm">Configure Easy Credit payment for Heidelpay
</a>
            </li>
        </ul>
        <p>&#160;</p>
        <p><![CDATA[
    ]]><i>Last
        review date: Nov. 15th, 2017</i><MadCap:conditionalText MadCap:conditions="General.Hidden Comment"><i> by Mykyta Borysevych</i></MadCap:conditionalText></p>
    </body>
</html>