<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:lastBlockDepth="2" MadCap:lastHeight="979" MadCap:lastWidth="4330" style="">
    <head>
    </head>
    <body>
        <h1>Personalization: Dynamic Pricing</h1>
        <p>Especially in businesses with a B2B focus, customers expect to get discounts after they have been using the service/website for a longer period of time. The search infrastructure should be able to handle such use cases and customers should be able to see their own discounted prices while browsing the catalog. Luckily, Elasticsearch enables us to extend basic filtering, aggregation and fetching functionalities with scripts that are executed within the document context and can be used instead of fixed document values.

</p>
        <p>In this example, we have a script with two customer-based parameters: fixed prices (one per product ID) and category discount levels. These parameters are passed to the Elasticsearch query only for logged-in customers with granted discounts.</p><pre><code class="language-PHP line-numbers">{
  "query": {
    "script_fields": {
      "final_gross_price_discount": {
        "script": "if (fixed_prices &amp;&amp; fixed_prices[doc['sku'].value]) {return fixed_prices[doc['sku'].value]}; if(!discounts) {return}; def discount = 0; for (String i : doc['discount_categories']) {if(discounts[i] &amp;&amp; discounts[i].value &gt; discount) {discount = discounts[i].value}}; if (discount &gt; 0 &amp;&amp; doc['prices.discount_gross_price_level_' + discount].value) {return doc['prices.discount_gross_price_level_' + discount].value}",
        "params": {
          "discounts": {
            "47": 5,
            "453": 2,
            "305": 7
          },
          "fixed_prices": {
            "210417044": 9999,
            "128553": 100
          }
        }
      }
    }
  }
}
</code></pre>
        <p>As a result, customers see personalized prices. In a similar way, itâ€™s possible to build filters and price facets based on dynamically calculated prices.
</p>
    </body>
</html>