<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="">
    <head>
    </head>
    <body>
        <h1>Tutorial - Customer Import</h1>
        <p>
            <img src="../../Resources/Images/shoptype/B2B_Shop.png" />
            <img src="../../Resources/Images/shoptype/B2C_Shop.png" />
            <img src="../../Resources/Images/shoptype/MasterSuite.png" />
            <img src="../../Resources/Images/shoptype/Demoshop.png" />
        </p>
        <p MadCap:conditions="General.Hidden Comment">used to be: http://spryker.github.io/tutorials/zed/import-customers/</p>
        <p>This tutorial describes the steps you need to follow in order to extend the <code>Importer</code> module functionality.</p>
        <p>In this example, we’ll import customer data; of course you can update the code in this tutorial to fit your need.</p>
        <h2>Customer Data File</h2>
        <p>In order to import customer data from a legacy system, the data needs to be exported to a CSV file in a format that fits the new database schema.</p>
        <p>In the <code>Importer</code> module, we’ll place the <code>customers.csv</code> file under the <code>src/Pyz/Zed/Importer/Business/Internal/data/</code> folder.</p>
        <p>The first line in the CSV file must describe the structure of the data we need to import. The other lines must respect this given structure and one row corresponds to one entry.</p><pre><code class="language-PHP line-numbers">customer_reference,email,first_name,last_name
DE--1,test_customer1@mail.com,Test,Customer1
DE--2,test_customer2@mail.com,Test,Customer2</code></pre>
        <h2>Implement Customer Installer</h2>
        <p>The data installer has knowledge on where to get the data from and which data importers are able to process it. The data installer receives one or more data importers, that are executing the actual import.</p>
        <p>Create the <code>CustomerInstaller</code> class under the <code>src/Pyz/Zed/Importer/Business/Installer/Customer/</code> folder.</p>
        <p>Place the following code in the <code>CustomerInstaller</code> class:</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Importer\Business\Installer\Customer;

use Pyz\Zed\Importer\Business\Installer\AbstractInstaller;
use Spryker\Service\UtilDataReader\UtilDataReaderServiceInterface;

class CustomerInstaller extends AbstractInstaller
{

    /**
     * @return \Spryker\Service\UtilDataReader\Model\BatchIterator\CountableIteratorInterface
     */
    protected function buildBatchIterator()
    {
        return $this-&gt;utilDataReaderService-&gt;getCsvBatchIterator($this-&gt;getCsvDataFilename());
    }

    /**
     * @return string
     */
    public function getTitle()
    {
        return 'Customers';
    }

    private function getCsvDataFilename()
    {
        return $this-&gt;dataDirectory . '/customers.csv';
    }
}</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <h3>InstallerFactory</h3>
        <p>Next, in the <code>InstallerFactory</code> we need to add a method that returns an instance of our new data installer.</p><pre><code class="language-PHP line-numbers">&lt;?php
 /**
     * @return \Pyz\Zed\Importer\Business\Installer\Customer\CustomerInstaller
     */
    public function createCustomerInstaller()
    {
        $customerInstaller = new CustomerInstaller(
            $this-&gt;getImporterCustomerCollection(),
            $this-&gt;getConfig()-&gt;getImportDataDirectory()
        );

        return $customerInstaller;
    }
    /**
     * @return \Pyz\Zed\Importer\Business\Importer\ImporterInterface[]
     */
    public function getImporterCustomerCollection()
    {
        return [
            ImporterConfig::RESOURCE_CUSTOMER =&gt; $this-&gt;createImporterFactory()-&gt;createCustomerImporter(),
        ];
    }</code></pre>
        <p>We’ll take care of the implementation of the customer importer further.</p>
        <p>Add the resource customer constant in the <code>ImporterConfig</code>:</p><pre><code class="language-PHP line-numbers">&lt;?php
const RESOURCE_CUSTOMER = 'RESOURCE_CUSTOMER';</code></pre>
        <h2>Implement Customer Importer</h2>
        <p>The importer is the class responsible for processing and converting the data from a legacy format it can understand to the new format and then import it to the database. Also, it checks if the import was already executed.</p>
        <p>Create the <code>CustomerImporter</code> class under the <code>src/Pyz/Zed/Importer/Business/Importer/Customer/</code> folder.</p>
        <p>Place the following code in the <code>CustomerImporter</code> class:</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre xml:space="preserve"><code class="bash">&lt;?php

namespace Pyz\Zed\Importer\Business\Importer\Customer;

use Generated\Shared\Transfer\CustomerTransfer;
use Pyz\Zed\Importer\Business\Importer\AbstractImporter;
use Pyz\Zed\Customer\Business\CustomerFacadeInterface;

class CustomerImporter extends AbstractImporter
{
    /**
     * @var \Pyz\Zed\Customer\Business\CustomerFacadeInterface
     */
    protected $customerFacade;

    /**
     * @param \Pyz\Zed\Customer\Business\CustomerFacadeInterface $customerFacade
     */
    public function __construct(
        CustomerFacadeInterface $customerFacade
    ) {
        $this-&gt;customerFacade = $customerFacade;
    }

    /**
     * @param array $data
     *
     * @return void
     */
    protected function importOne(array $data)
    {
        $customer = $this-&gt;format($data);
        $customerTransfer = new CustomerTransfer();
        $customerTransfer-&gt;setCustomerReference($customer["customer_reference"]);
        $customerTransfer-&gt;setEmail($customer["email"]);
        $customerTransfer-&gt;setFirstName($customer["first_name"]);
        $customerTransfer-&gt;setLastName($customer["last_name"]);

        $this-&gt;customerFacade-&gt;createCustomer($customerTransfer);
    }

    /**
     * @return bool
     */
    public function isImported()
    {
        return $this-&gt;customerFacade-&gt;customersAreImported();
    }

    /**
     * @return string
     */
    public function getTitle()
    {
        return `Customer Import`;
    }
}</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <h3>ImporterFactory</h3>
        <p>Next, in the <code>ImporterFactory</code> we need to add a method that creates an instance of our new data importer.</p><pre><code class="language-PHP line-numbers">&lt;?php

    /**
     * @return \Pyz\Zed\Importer\Business\Importer\Customer\CustomerImporter
     */
    public function createCustomerImporter()
    {
        $customerImporter = new CustomerImporter(
            $this-&gt;getCustomerFacade()
        );

        return $customerImporter;
    }</code></pre>
        <h3>Add the Dependency to the <code>Customer</code> Module</h3>
        <p>Since we need to use the <code>CustomerFacade</code>, we need to add this dependency.</p>
        <p>In the <code>ImporterDependencyProvider</code> add the dependency to the <code>CustomerBundle</code> in the <code>provideBusinessLayerDependencies(Container $container)</code> method:</p><pre><code class="language-PHP line-numbers">&lt;?php
    const FACADE_CUSTOMER = 'FACADE_CUSTOMER';

    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Kernel\Container
     */
    public function provideBusinessLayerDependencies(Container $container)
    {
        $container = parent::provideBusinessLayerDependencies($container);
        //..

        $container[static::FACADE_CUSTOMER] = function (Container $container) {
            return $container-&gt;getLocator()-&gt;customer()-&gt;facade();
        };

        return $container;
    }</code></pre>
        <p>Add a method that returns an instance of the <code>CustomerFacade</code> in the <code>AbstractFactory</code>:</p><pre><code class="language-PHP line-numbers">    &lt;?php
    /**
     * @return \Pyz\Zed\Category\Business\CustomerFacadeInterface
     */
    protected function getCustomerFacade()
    {
        return $this-&gt;getProvidedDependency(ImporterDependencyProvider::FACADE_CUSTOMER);
    }</code></pre>
        <h2>Extend Customer Module</h2>
        <p>As you can see, the importer calls some methods from the <code>CustomerFacade</code> that don’t exist yet.</p>
        <p>Next, we’ll need to extend the <code>CustomerFacade</code> so that it implements and exposes those 2 methods that we need for our data import.</p>
        <p>Create the <code>Business</code> layer in the <code>Customer</code> module. Add a <code>CustomerWriter</code> class, where we’ll implement the business logic for these 2 operations.</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Customer\Business;

use Generated\Shared\Transfer\CustomerTransfer;
use Spryker\Zed\Customer\Persistence\CustomerQueryContainerInterface;
use Orm\Zed\Customer\Persistence\SpyCustomer;

class CustomerWriter
{

    /**
     * @var \Spryker\Zed\Customer\Persistence\CustomerQueryContainerInterface
     */
    protected $queryContainer;


    /**
     * @param \Spryker\Zed\Customer\Persistence\CustomerQueryContainerInterface $queryContainer
     */
    public function __construct(CustomerQueryContainerInterface $queryContainer)
    {
        $this-&gt;queryContainer = $queryContainer;
    }

    /**
     * @return bool
     */
    public function customersAreImported()
    {
        return $this-&gt;queryContainer-&gt;queryCustomers()-&gt;count() &gt; 0;
    }

    /**
     * @param \Generated\Shared\Transfer\CustomerTransfer $customerTransfer
     */
    public function createCustomer(CustomerTransfer $customerTransfer)
    {
        $customerEntity = new SpyCustomer();
        $customerEntity-&gt;fromArray($customerTransfer-&gt;toArray());
        $customerEntity-&gt;save();
    }

}</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <p>To be able to get an instance of the <code>CustomerWriter</code> in our facade, add a <code>CustomerBusinessFactory</code> under the business layer with a method that creates the <code>CustomerWriter</code>.</p><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Customer\Business;

use Spryker\Zed\Customer\Business\CustomerBusinessFactory as SprykerCustomerBusinessFactory;

/**
 * @method \Spryker\Zed\Customer\Persistence\CustomerQueryContainer getQueryContainer()
 */
class CustomerBusinessFactory extends SprykerCustomerBusinessFactory
{

    /**
     * @return \Pyz\Zed\Customer\Business\CustomerWriter
     */
    public function createCustomerWriter()
    {
        return new CustomerWriter($this-&gt;getQueryContainer());
    }

}</code></pre>
        <p>Next, we’ll need to extend the <code>CustomerFacade</code> so that it exposes the functionality we just added.</p>
        <p>First, add the <code>CustomerFacadeInterface</code> that extends the interface of the facade from the core level with 2 new operations.</p><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Customer\Business;

use Spryker\Zed\Customer\Business\CustomerFacadeInterface as SprykerCustomerFacadeInterface;
use Generated\Shared\Transfer\CustomerTransfer;

interface CustomerFacadeInterface extends SprykerCustomerFacadeInterface
{
    /**
     * @return bool
     */
    public function customersAreImported();

    /**
     * @param \Generated\Shared\Transfer\CustomerTransfer $customerTransfer
     */
    public function createCustomer(CustomerTransfer $customerTransfer);
}</code></pre>
        <p>Next, add the <code>CustomerFacade</code> that extends the facade defined on the core level:</p>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>Click to expand the code sample</MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Customer\Business;

use Spryker\Zed\Customer\Business\CustomerFacade as SprykerCustomerFacade;
use Generated\Shared\Transfer\CustomerTransfer;

/**
 * @method \Pyz\Zed\Customer\Business\CustomerBusinessFactory getFactory()
 */
class CustomerFacade extends SprykerCustomerFacade implements CustomerFacadeInterface
{

    /**
     * @return bool
     */
    public function customersAreImported()
    {
        return $this-&gt;getFactory()-&gt;createCustomerWriter()-&gt;customersAreImported();
    }

    /**
     * @param \Generated\Shared\Transfer\CustomerTransfer $customerTransfer
     */
    public function createCustomer(CustomerTransfer $customerTransfer)
    {
        $this-&gt;getFactory()-&gt;createCustomerWriter()-&gt;createCustomer($customerTransfer);
    }

}</code></pre>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <h2>Register the new data installer</h2>
        <p>Now we’re almost ready to test the new data installer; we just need to register it in the <code>ImporterBusinessFactory</code>:</p><pre><code class="language-PHP line-numbers">&lt;?php
/**
     * @return \Pyz\Zed\Importer\Business\Installer\InstallerInterface[]
     */
    protected function getInstallerCollection()
    {
        return [
            //..
            ImporterConfig::RESOURCE_CUSTOMER =&gt; $this-&gt;createInstallerFactory()-&gt;createCustomerInstaller()
        ];
    }</code></pre>
        <p>For testing the customer data installer you just need to run the data import from the command line:</p><pre><code class="language-PHP line-numbers">vendor/bin/console import:demo-data</code></pre>
    </body>
</html>