<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="">
    <head>
    </head>
    <body>
        <h1>Tutorial - OMS State Machine - Legacy Demoshop</h1>
        <p>
            <img src="../../Resources/Images/shoptype/Demoshop.png" />
        </p>
        <h2>Challenge Description</h2>
        <p>Create a simple state machine that demonstrates an order process. The simple order process has the following states: new, paid, shipped, closed, returned, and invalid. We use the invalid state in case a payment is unauthorized (could be used with some other cases as well). In order to build the state machine, only three main steps are needed.</p>
        <h2>1. Create the State Machine Graph</h2>
        <p>The first step is to create the graph that demonstrates the state machine and contains the states with their transitions, events, commands, and conditions. State machines in Spryker are built using easy and well structured XML files. Let’s get started and create the state machine.</p>
        <ul>
            <li class="bullet_list">Create a new XML file in <code>\config\Zed\oms</code> and call it <code>Demo01.xml</code>.</li>
            <li class="bullet_list">Add the <code>Demo01</code> state machine as an active process in <code>config_default.php</code> under <code>\config\Shared\</code> by adding it to the <code>$config[OmsConstants::ACTIVE_PROCESSES]</code> array.</li>
            <li class="bullet_list">Now let’s go back to the XML file. To build the state machine main schema, use the <code>statemachine</code> and <code>process</code> elements and the Spryker OMS schema like following:</li>
        </ul><pre><code class="language-PHP line-numbers">    &lt;?xml version="1.0"?&gt;
    &lt;statemachine
        xmlns="spryker:oms-01"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="spryker:oms-01 http://static.spryker.com/oms-01.xsd"&gt;

        &lt;process name="Demo01" main="true"&gt;

        &lt;/process&gt;

    &lt;/statemachine&gt;</code></pre>
        <ul>
            <li class="bullet_list">Now you are ready to add the states to the state machine. Add the first state new inside the process element using the state element like this:</li>
        </ul><pre><code class="language-PHP line-numbers">    &lt;states&gt;
        &lt;state name="new"/&gt;
    &lt;/states&gt;</code></pre>
        <ul>
            <li class="bullet_list">To see the state machine graph while, and after, building it, go to <a href="http://zed.de.demoshop.local/oms" target="_blank">Zed UI -&gt; Maintenance -&gt; OMS</a> and then you will see your state machine <code>Demo01</code>. Click on it and you will see the graph that represents your XML file.</li>
            <li class="bullet_list">Add the other states to you state machine and refresh the graph to see the new changes.</li>
            <li class="bullet_list">After adding all the states, you can now start adding the <code>transition</code> and their events. To do so use the transitions element like this:</li>
        </ul><pre><code class="language-PHP line-numbers">    &lt;transition&gt;
        &lt;source&gt;new&lt;/source&gt;
        &lt;target&gt;paid&lt;/target&gt;
        &lt;event&gt;pay&lt;/event&gt;
    &lt;/transition&gt;</code></pre>
        <p>A transition defines the source state, the target state, and the event to trigger the transition.</p>
        <ul>
            <li class="bullet_list">Now add the event like this:</li>
        </ul><pre><code class="language-PHP line-numbers">    &lt;events&gt;
        &lt;event name="pay" onEnter="true"/&gt;
    &lt;/events&gt;</code></pre>
        <p><code>onEnter</code> event means that this transition will be triggered automatically. You can also use <code>manual</code> or <code>timeout</code>. A <code>manual</code> event will add a button in the order page to allow triggering the event manually. A <code>timeout</code> one will be triggered after the specified time is out. A timeout could be defined using natural language e.g. <code>14days</code>.</p>
        <ul>
            <li class="bullet_list">Add all the other needed transitions and events until you have a logically working graph. Refresh every time you add something new to see the changes live.</li>
        </ul>
        <h2>2. Add Commands and Conditions to the State Machine</h2>
        <p>In state machine real live scenarios, most probably you need to use PHP implementations for some specific logic like sending request to a payment provider or an ERP system. To do so, Spryker provides Commands and Conditions. Commands are triggered with events, therefore they are added to events, and conditions helps deciding to which state an item should move next, and therefore they are added to transitions.</p>
        <ul>
            <li class="bullet_list">Add a command to the <code>pay</code> event like this:</li>
        </ul><pre><code class="language-PHP line-numbers">    &lt;events&gt;
        &lt;event name="pay" onEnter="true" command="Demo/Pay"/&gt;
    &lt;/events&gt;</code></pre>
        <ul>
            <li class="bullet_list">Add the other commands to the other events.</li>
            <li class="bullet_list">Now add conditions where needed in order to make decisions where to move next. This works well with payments. So let’s add a conditions to the <code>paid-&gt;shipped </code>transition like this:</li>
        </ul><pre><code class="language-PHP line-numbers">    &lt;transition condition="Demo/IsPaymentAuthorized"&gt;
        &lt;source&gt;paid&lt;/source&gt;
        &lt;target&gt;shipped&lt;/target&gt;
        &lt;event&gt;ship&lt;/event&gt;
    &lt;/transition&gt;</code></pre>
        <p>The state machine engine recognizes where to move next using the event name. In this case, the transitions <code>paid-&gt;shipped</code> and <code>paid-&gt;invalid</code> should use the same event name with a condition on one of the transitions. The machine then will examine the condition, if it returns <code>true</code> then go to <code>shipped</code> state, otherwise go to <code>invalid</code>. If you check the drafted state machine in Zed now, you can see that the conditions and commands are marked with red color (“not implemented”). So let’s implement them.</p>
        <ul>
            <li class="bullet_list">In order to implement the commands and conditions, we use Spryker Command and Condition interfaces <code>CommandByOrderInterface</code> and <code>ConditionInterface</code>.</li>
            <li class="bullet_list">Go to <code>src/Pyz/Zed/Oms/Communication/Plugin/Oms/Command/</code> and create a new folder called <code>Demo</code>. Now create a new class and call it <code>PayCommand.php</code>. Then implement the command interface with the <code>run()</code> method like this:</li>
        </ul><pre><code class="language-PHP line-numbers">&lt;?php
    namespace Pyz\Zed\Oms\Communication\Plugin\Oms\Command\Demo;

    use Orm\Zed\Sales\Persistence\SpySalesOrder;
    use Spryker\Zed\Oms\Business\Util\ReadOnlyArrayObject;
    use Spryker\Zed\Oms\Communication\Plugin\Oms\Command\AbstractCommand;
    use Spryker\Zed\Oms\Dependency\Plugin\Command\CommandByOrderInterface;

    class PayCommand extends AbstractCommand implements CommandByOrderInterface
    {

        /**
         * @param array $orderItems
         * @param \Orm\Zed\Sales\Persistence\SpySalesOrder $orderEntity
         * @param \Spryker\Zed\Oms\Business\Util\ReadOnlyArrayObject $data
         *
         * @return array
         */
        public function run(array $orderItems, SpySalesOrder $orderEntity, ReadOnlyArrayObject $data)
        {
            return [];
        }

    }</code></pre>
        <p>You can add any implementation to the <code>PayCommand</code>, or just return an empty array for now.</p>
        <ul>
            <li class="bullet_list">Do the same thing for the other commands.</li>
            <li class="bullet_list">Follwing the same approach, add the condition to <code>src/Pyz/Zed/Oms/Communication/Plugin/Oms/Condition/</code> by creating a new <code>Demo</code> folder and a condition class in it called <code>IsPaymentAuthorizedCondition.php</code>. The condition can be implemented like this:</li>
        </ul><pre><code class="language-PHP line-numbers">&lt;?php
namespace Pyz\Zed\Oms\Communication\Plugin\Oms\Condition\Demo;

use Orm\Zed\Sales\Persistence\SpySalesOrderItem;
use Spryker\Zed\Oms\Communication\Plugin\Oms\Condition\AbstractCondition;
use Spryker\Zed\Oms\Dependency\Plugin\Condition\ConditionInterface;

class IsPaymentAuthorizedCondition extends AbstractCondition implements ConditionInterface
{

    /**
     * @api
     *
     * @param \Orm\Zed\Sales\Persistence\SpySalesOrderItem $orderItem
     *
     * @return bool
     */
    public function check(SpySalesOrderItem $orderItem)
    {
        return true;
    }

}</code></pre>
        <ul>
            <li class="bullet_list">After implementing the command and conditions, you need now to register them in the OMS module. To do so, go to <code>OmsDependencyProvider</code> in <code>src/Pyz/Zed/Oms/</code> and extend the <code>getConditionPlugins()</code> and <code>getCommandPlugins()</code> methods:</li>
        </ul><pre><code class="language-PHP line-numbers">&lt;?php
    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Kernel\Container
     */
    public function provideBusinessLayerDependencies(Container $container)
    {
        $container = parent::provideBusinessLayerDependencies($container);
        $container-&gt;extend(self::COMMAND_PLUGINS, function (CommandCollectionInterface $commandCollection) {
            $commandCollection-&gt;add(new PayCommand(), 'Demo/Pay');

            return $commandCollection;
        });

        $container-&gt;extend(self::CONDITION_PLUGINS, function (ConditionCollectionInterface $conditionCollection) {
             $conditionCollection-&gt;add(new IsPaymentAuthorizedCondition(), 'Demo/IsPaymentAuthorized');

             return $conditionCollection;
        });

        return $container;
    }</code></pre>
        <ul>
            <li class="bullet_list">Now, refresh the state machine graph, you should see everything correctly implmented and the red messages are gone.</li>
        </ul>
        <h2>3. Activate the State Machine</h2>
        <p>The final step is to activate and use the state machine by hooking it into the checkout. To do so:</p>
        <ul>
            <li class="bullet_list">Open the configuration file: <code>config/Shared/config_default.php</code>.</li>
            <li class="bullet_list">Change the invoice payment configuration to use the <code>Demo01</code> state machine instead of <code>DummyPayment01</code>.</li>
        </ul><pre><code class="language-PHP line-numbers">&lt;?php
$config[SalesConstants::PAYMENT_METHOD_STATEMACHINE_MAPPING] = [
    DummyPaymentConfig::PAYMENT_METHOD_INVOICE =&gt; 'Demo01',
    ...
];</code></pre>
        <p>Next time you checkout with “Invoice” payment, the new <code>Demo01</code> state machine will be used.</p>
        <h2>Testing the State Machine</h2>
        <p>That’s it! You have just built a new order process. To test it:</p>
        <ul>
            <li class="bullet_list">Go to the <a href="http://www.de.demoshop.local/" target="_blank" title="demoshop" alt="demoshop">demoshop</a>, choose a product and add it to cart, checkout using <code>Invoice</code>, and complete the order.</li>
            <li class="bullet_list">Open the <a href="http://zed.de.demoshop.local/sales" target="_blank" title="demoshop orders page" alt="demoshop orders page">orders page</a> in Zed UI and then open your order. This order is now applying the process you have defined in the state machine. All the <code>manual</code> events add buttons using the event names you defined, while the <code>onEnter</code> ones move automatically.</li>
            <li class="bullet_list">You can click on the state machine name <code>Demo01</code> under the process column to see what the current state for a specific item is. The current state has a yellowish background color.</li>
            <li class="bullet_list">Now click on <code>ship</code> to move the item into the next state.</li>
            <li class="bullet_list">Click again on the state machine name <code>Demo01</code> and check the current state.</li>
            <li class="bullet_list">You can keep moving the item until the order is closed.</li>
        </ul>
        <h2>Nice Addition</h2>
        <p>Along with the nice representation of the state machine as graph, Spryker provides a flag called <code>happy</code> to add green arrows in the graph in order to define the happy path of an order item. To add this flag, just write <code>happy = true</code> on the transitions that are part of the happy path like this for example:</p><pre><code class="language-PHP line-numbers">    &lt;transition condition="Demo/IsPaymentAuthorized" happy="true"&gt;
        &lt;source&gt;paid&lt;/source&gt;
        &lt;target&gt;shipped&lt;/target&gt;
        &lt;event&gt;ship&lt;/event&gt;
    &lt;/transition&gt;</code></pre>
        <p>&#160;</p>
        <p><b>See also:</b>
        </p>
        <ul>
            <li><a href="http://documentation.spryker.com/state_machine_cookbook/state-machine-cookbook.htm">State Machines - The Cook Book</a>
            </li>
            <li><a href="http://documentation.spryker.com/capabilities/order_management/oms-matrix.htm">Order Management System Matrix</a>
            </li>
        </ul>
    </body>
</html>