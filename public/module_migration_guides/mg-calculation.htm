<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="_Skins_HTML5___Top_Navigation" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../" data-mc-has-content-body="True" data-mc-conditions="General.Demoshop,Spryker.B2B,Spryker.B2C,Spryker.DemoShop,Spryker.ShopSuite" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Migration and Integration|Module Migration Guides">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="msapplication-config" content="../Skins/Favicons/browserconfig.xml" />
        <link rel="apple-touch-icon" sizes="180x180" href="../Skins/Favicons/apple-touch-icon.png" />
        <link rel="shortcut icon" href="../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="96x96" href="../Skins/Favicons/favicon-96x96.png" />
        <link rel="icon" sizes="32x32" href="../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="16x16" href="../Skins/Favicons/favicon-16x16.png" />
        <meta charset="utf-8" />
        <meta name="description" content="" />
        <meta name="author" content="" /><title>Migration Guide - Calculation    </title>
        <!-- Google Tag Manager -->
        <script>/* <![CDATA[ */(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
			'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-NP24S2');/* ]]> */</script>
        <!-- End Google Tag Manager -->
        <script>/* <![CDATA[ */
			var s = document.createElement("script");
			s.type = "text/javascript";
			s.src = "https://www.googletagmanager.com/gtag/js?id==UA-56589105-4";
			document.getElementsByTagName('head').item(0).appendChild(s);
		/* ]]> */</script>
        <script>/* <![CDATA[ */
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-56589105-4');
		/* ]]> */</script>
        <link href="../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/foundation.6.2.3.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/styles.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/tablet.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/mobile.css" rel="stylesheet" />
        <link href="../resources/stylesheets/perfect-scrollbar.css" rel="stylesheet" />
        <link href="../resources/stylesheets/prism.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.previous-topic-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/navigate-previous.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.next-topic-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/navigate-next.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../resources/scripts/PIE-no-motw.htc');
}

</style>
        <link href="../resources/stylesheets/mainstyles.css" rel="stylesheet" />
        <script src="../resources/scripts/custom.modernizr.js">
        </script>
        <script src="../resources/scripts/jquery.min.js">
        </script>
        <script src="../resources/scripts/require.min.js">
        </script>
        <script src="../resources/scripts/require.config.js">
        </script>
        <script src="../resources/scripts/foundation.6.2.3_custom.js">
        </script>
        <script src="../resources/scripts/plugins.min.js">
        </script>
        <script src="../resources/scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="small" data-mc-ignore="true">
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <button class="menu-icon" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../home.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form class="search" action="#">
                                            <div class="search-bar search-bar-container needs-pie">
                                                <input class="search-field needs-pie" type="search" placeholder="Search the Academy" />
                                                <div class="search-filter-wrapper">
                                                    <div class="search-filter">
                                                        <div class="search-filter-content">
                                                            <ul>
                                                                <li>All Files</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="search-submit-wrapper" dir="ltr">
                                                    <div class="search-submit" title="Search">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <section class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <div class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </div>
                            <div class="body-container" data-mc-content-body="True">
                                <!-- Google Tag Manager (noscript) -->
                                <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP24S2" height="0" width="0" style="display:none;visibility:hidden"></iframe>
                                </noscript>
                                <!-- End Google Tag Manager (noscript) -->
                                <div class="search-container">
                                    <form class="search" action="#">
                                        <div class="search-bar search-bar-container needs-pie _Skins_SearchTopics mc-component">
                                            <input class="search-field needs-pie" type="search" placeholder="Search" />
                                            <div class="search-filter-wrapper">
                                                <div class="search-filter">
                                                    <div class="search-filter-content">
                                                        <ul>
                                                            <li>All Files</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="search-submit-wrapper" dir="ltr">
                                                <div class="search-submit" title="Search">
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="row collapse">
                                    <div class="top-bar">
                                        <div class="breadcrumbs-block">
                                            <div class="nocontent">
                                                <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                        </div>
                                        <form class="search" action="#">
                                            <div class="search-bar search-bar-container needs-pie _Skins_SearchHome mc-component">
                                                <input class="search-field needs-pie" type="search" placeholder="Search" />
                                                <div class="search-filter-wrapper">
                                                    <div class="search-filter">
                                                        <div class="search-filter-content">
                                                            <ul>
                                                                <li>All Files</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="search-submit-wrapper" dir="ltr">
                                                    <div class="search-submit" title="Search">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="topic-layout">
                                        <div>
                                            <div class="side-menu">
                                                <div data-sticky-container="" id="_zApaJBo5USjkLT8zP_-9g">
                                                    <div class="sticky sticky-menu" style="width:100%" data-sticky="" data-top-anchor="_zApaJBo5USjkLT8zP_-9g:top" data-bottom-anchor="contentBody:bottom" data-sticky-on="small" data-scroll-container-on="small">
                                                        <ul class="nocontent menu _Skins_SideMenu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/master.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="side-menu">
                                                <div class="toolbar-wrapper">
                                                    <div class="widget-github js-widget-github"><a class="widget-github-link js-widget-github-link" href="https://github.com/spryker/spryker-documentation" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M13.5 0C6.057 0 0 6.057 0 13.5c0 5.888 3.791 10.905 9.058 12.745a.463.463 0 0 0 .258.088c1.316.43 2.724.667 4.184.667C20.943 27 27 20.943 27 13.5S20.943 0 13.5 0zm0 .931c6.93 0 12.569 5.639 12.569 12.569 0 5.428-3.459 10.061-8.287 11.818a1.903 1.903 0 0 1-.092-.527v-2.446c0-.975-.477-2.037-.946-2.75 2.584-.436 5.537-1.776 5.537-6.779 0-1.37-.429-2.58-1.275-3.598.186-.611.415-1.9-.225-3.52a.47.47 0 0 0-.291-.272c-.13-.04-1.326-.35-3.806 1.277a12.921 12.921 0 0 0-6.36 0c-2.481-1.63-3.68-1.319-3.809-1.277a.47.47 0 0 0-.29.273C5.582 7.319 5.811 8.607 6 9.218c-.85 1.018-1.279 2.227-1.279 3.598 0 4.957 2.9 6.323 5.463 6.778-.322.407-.66.934-.81 1.47-.661.184-2.018.19-2.929-1.37-.032-.06-.829-1.475-2.4-1.584-.25.002-.882.042-1.035.525-.169.537.424.944.679 1.117l.058.034c.029.015.707.371 1.213 1.644.105.333 1.03 2.84 4.353 2.399.002.367 0 .552-.004.7v.26c0 .15-.045.378-.096.525C4.386 23.558.931 18.924.931 13.5.931 6.57 6.57.931 13.5.931zm6.51 5.375c.5 1.471.158 2.537.035 2.839a.468.468 0 0 0 .089.49c.805.883 1.214 1.952 1.214 3.181 0 4.72-2.796 5.666-5.535 5.97a.464.464 0 0 0-.253.815c.368.314 1.199 1.68 1.199 2.744v2.446c0 .009.001.414.134.809a12.513 12.513 0 0 1-6.792-.002c.135-.396.139-.802.139-.81l.001-.248c.002-.211.006-.497 0-1.266a.473.473 0 0 0-.174-.362.47.47 0 0 0-.391-.09c-3.126.681-3.802-1.576-3.828-1.67l-.016-.047c-.448-1.135-1.037-1.713-1.388-1.975.759.267 1.182 1.007 1.193 1.024 1.231 2.107 3.264 2.162 4.328 1.685a.463.463 0 0 0 .27-.36c.095-.665.826-1.545 1.196-1.87a.464.464 0 0 0 .136-.488.461.461 0 0 0-.39-.324c-2.73-.31-5.524-1.266-5.524-5.98 0-1.228.41-2.3 1.219-3.181a.464.464 0 0 0 .087-.491c-.124-.302-.467-1.364.031-2.837.396.013 1.362.182 2.988 1.286.112.076.256.1.387.063.973-.27 2.058-.416 3.135-.421 1.08.005 2.166.15 3.14.421.131.037.273.013.386-.063 1.635-1.11 2.6-1.275 2.984-1.288z" /></svg></a>
                                                    </div>
                                                    <div class="buttons popup-container clearfix topicToolbarProxy _Skins_TopicToolbar mc-component nocontent" style="mc-topic-toolbar-items: PreviousTopic NextTopic Print ExpandAll CollapseAll;">
                                                        <div class="button-group-container-left">
                                                            <button class="button needs-pie previous-topic-button" title="Navigate previous">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="previous topic" />
                                                            </button>
                                                            <button class="button needs-pie next-topic-button" title="Navigate next">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="next topic" />
                                                            </button>
                                                            <button class="button needs-pie print-button" title="Print">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                                            </button>
                                                            <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="js-anchorer main-content">
                                                    <h1>Migration Guide - Calculation <img src="../resources/images/shoptype/b2b_shop.png" /> <img src="../resources/images/shoptype/b2c_shop.png" /> <img src="../resources/images/shoptype/mastersuite.png" /> <img src="../resources/images/shoptype/demoshop.png" /></h1>
                                                    <div class="MCDropDown MCDropDown_Closed dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" /><div class="drop-anchor">Upgrading from Version 3.* to Version 4.*</div></a></span>
                                                        <div class="MCDropDownBody dropDownBody">
                                                            <p>To upgrade from 3* to 4*, composer update your calculator to version 4.</p>
                                                            <div class="MCDropDown MCDropDown_Closed dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" /><div class="drop-anchor">Updating Calculator Stacks</div></a></span>
                                                                <div class="MCDropDownBody dropDownBody">
                                                                    <p>In the new version there are two new calculator stacks, <var>getQuoteCalculatorPluginStack</var> and <var>getOrderCalculatorPluginStack</var>. They are both defined in <var>\Pyz\Zed\Calculation\CalculationDependencyProvider</var>.</p>
                                                                    <p class="important">In the previous version (3*), the calculator stack was called&#160;<var>getCalculatorStack</var>. <br />You must rename this method to <var>getQuoteCalculatorPluginStack</var>.</p>
                                                                    <p>By default the demoshop ships with these plugins. If you have your custom plugins, please add them accordingly, old and new calculators plugins are backwards compatible.</p>
                                                                    <p>If you want to keep having old calculated fields, add the plugins to <var>getQuoteCalculatorPluginStack</var>. Take into consideration, that we recommend you discard old plugins and use the new ones.</p><pre><code class="language-PHP line-numbers">&lt;?php
new ProductOptionGrossSumCalculatorPlugin(),
new ProductOptionTaxRateCalculatorPlugin(),
new SumGrossCalculatedDiscountAmountCalculatorPlugin(),
new ItemsWithProductOptionsAndDiscountsGrossPriceCalculatorPlugin(),
new ItemsWithProductOptionsAndDiscountsTaxCalculatorPlugin(),
new ExpenseTaxCalculatorPlugin(),</code></pre>
                                                                    <p class="note">The old Calculator plugins were moved to the following separate repository: <var>spryker/calculation-migration</var>. <br />Please include into your <var>composer.json</var> like <var>"spryker/calculation-migration": "dev-master"</var> and run <var>composer update</var>. <br />This should enable you to use old plugins.</p>
                                                                    <p>The Caclulator module also returns <var>back sales.fk_customer</var>, <var>sales.fk_shipment_method</var>, <var>sales.shipment_delivery_time</var> - these are deprecated methods. To safely migrate them see <a href="mg-sales.htm" class="MCXref xref">Migration Guide - Sales    </a>.</p>
                                                                    <p>After this you should see new values calculated + legacy ones.</p><![CDATA[
        
                        
            ]]><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Calculation;

use Spryker\Zed\Calculation\Communication\Plugin\Calculator\DiscountAmountAggregatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\DiscountTotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\ExpenseTotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\GrandTotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\InitialGrandTotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\ItemDiscountAmountFullAggregatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\PriceCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\PriceToPayAggregatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\ItemProductOptionPriceAggregatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\ItemSubtotalAggregatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\ItemTaxAmountFullAggregatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\RefundableAmountCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\RefundTotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\RemoveAllCalculatedDiscountsCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\SubtotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\TaxTotalCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\RemoveTotalsCalculatorPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\CanceledTotalCalculationPlugin;
use Spryker\Zed\Calculation\Communication\Plugin\Calculator\OrderTaxTotalCalculationPlugin;
use Spryker\Zed\Tax\Communication\Plugin\Calculator\TaxAmountCalculatorPlugin;
use Spryker\Zed\Tax\Communication\Plugin\Calculator\TaxAmountAfterCancellationCalculatorPlugin;
use Spryker\Zed\Tax\Communication\Plugin\Calculator\TaxRateAverageAggregatorPlugin;
use Spryker\Zed\DiscountCalculationConnector\Communication\Plugin\DiscountCalculatorPlugin;
use Spryker\Zed\ProductBundle\Communication\Plugin\Calculation\CalculateBundlePricePlugin;
use Spryker\Zed\ProductOption\Communication\Plugin\ProductOptionTaxRateCalculatorPlugin;
use Spryker\Zed\Shipment\Communication\Plugin\ShipmentTaxRateCalculatorPlugin;
use Spryker\Zed\TaxProductConnector\Communication\Plugin\ProductItemTaxRateCalculatorPlugin;
use Spryker\Zed\Kernel\Container;
use Spryker\Zed\Calculation\CalculationDependencyProvider as SprykerCalculationDependencyProvider;

class CalculationDependencyProvider extends SprykerCalculationDependencyProvider
{

    protected function getQuoteCalculatorPluginStack(Container $container)
       {
           return [
               new RemoveTotalsCalculatorPlugin(),
               new RemoveAllCalculatedDiscountsCalculatorPlugin(),

               new PriceCalculatorPlugin(),
               new ItemProductOptionPriceAggregatorPlugin(),
               new ItemSubtotalAggregatorPlugin(),

               new SubtotalCalculatorPlugin(),

               new InitialGrandTotalCalculatorPlugin(),
               new DiscountCalculatorPlugin(),
               new DiscountAmountAggregatorPlugin(),
               new ItemDiscountAmountFullAggregatorPlugin(),

               new ProductItemTaxRateCalculatorPlugin(),
               new ProductOptionTaxRateCalculatorPlugin(),
               new ShipmentTaxRateCalculatorPlugin(),
               new TaxAmountCalculatorPlugin(),
               new ItemTaxAmountFullAggregatorPlugin(),

               new PriceToPayAggregatorPlugin(),

               new TaxRateAverageAggregatorPlugin(),

               new RefundableAmountCalculatorPlugin(),

               new CalculateBundlePricePlugin(),

               new ExpenseTotalCalculatorPlugin(),
               new DiscountTotalCalculatorPlugin(),
               new RefundTotalCalculatorPlugin(),
               new GrandTotalCalculatorPlugin(),

               new TaxTotalCalculatorPlugin(),
           ];
       }

       protected function getOrderCalculatorPluginStack(Container $container)
       {
           return [

                   new PriceCalculatorPlugin(),
                   new ItemProductOptionPriceAggregatorPlugin(),
                   new ItemSubtotalAggregatorPlugin(),

                   new SubtotalCalculatorPlugin(),

                   new DiscountAmountAggregatorPlugin(),
                   new ItemDiscountAmountFullAggregatorPlugin(),

                   new PriceToPayAggregatorPlugin(),

                   new TaxAmountCalculatorPlugin(),
                   new ItemTaxAmountFullAggregatorPlugin(),
                   new TaxAmountAfterCancellationCalculatorPlugin(),

                   new RefundableAmountCalculatorPlugin(),

                   new ExpenseTotalCalculatorPlugin(),
                   new DiscountTotalCalculatorPlugin(),
                   new RefundTotalCalculatorPlugin(),
                   new CanceledTotalCalculationPlugin(),
                   new GrandTotalCalculatorPlugin(),

                   new OrderTaxTotalCalculationPlugin(),
           ];
       }
}</code></pre></div>
                                                            </div>
                                                            <div class="MCDropDown MCDropDown_Closed dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" /><div class="drop-anchor">Changing Displayed Calculated Values</div></a></span>
                                                                <div class="MCDropDownBody dropDownBody">
                                                                    <p>You may also want to change displayed calculated values in your twig templates.</p>
                                                                    <p>Instead of using specific calculated fields, there are more generic fields provided with the new calculator version.</p>
                                                                    <p>If you were using <var>ItemTransfer::unitGrossPrice</var> or <var>ProductOptionTransfer::unitGrossPrice</var>, replace this with <var>ItemTransfer::unitPrice</var> or <var>ProductOptionTransfer::unitPrice</var> - these values are used mostly in cart details, checkout summary or customer order details pages.</p>
                                                                    <p>You also need to update <var>Price` &gt;= 4.*</var> and <var>PriceCartConnector` &gt;= 3.*</var> as they provide additional data to the quote transfer when "adding to cart". (<var>QuoteTransfer::priceMode</var>).</p>
                                                                    <p>It is necessary only if you extended the <var>\Spryker\Zed\PriceCartConnector\Business\Manager\PriceManager</var> class, because you will receive this change when you update the module.</p>
                                                                    <h4>Update Cart Expander Plugin CartItemPricePlugin</h4>
                                                                    <p>If you extended the core CartItemPricePlugin, adapt the following code:</p><pre><code class="language-PHP line-numbers">&lt;?php
use Spryker\Shared\Price\PricePriceMode;
...
public function addGrossPriceToItems(CartChangeTransfer $cartChangeTransfer)
{
    $cartChangeTransfer-&gt;setQuote($this-&gt;setQuotePriceMode($cartChangeTransfer-&gt;getQuote()));
    ....
}

protected function setQuotePriceMode(QuoteTransfer $quoteTransfer)
{
    $quoteTransfer-&gt;setPriceMode(PricePriceMode::PRICE_MODE_GROSS);

    return $quoteTransfer;
}

?&gt;</code></pre>
                                                                    <h4><a name="Migratin"></a>Migrating Sales to the New Calculator Logic</h4>
                                                                    <p>To migrate all your orders, do the following:</p>
                                                                    <ol>
                                                                        <li value="1">Update Yves to use the new version of the Calculator module with the new Calculator plugins.</li>
                                                                        <li value="2">Update your schema by running the following SQL inserts:</li>
                                                                    </ol>
                                                                    <p class="note">By default, all data is nullable so you can easily run inserts. We will provide a migration script to make those fields not nullable after migration is done.</p>
                                                                    <div class="MCDropDown MCDropDown_Closed dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" /><div class="drop-anchor">Click here to expand the code sample</div></a></span>
                                                                        <div class="MCDropDownBody dropDownBody"><pre><code class="language-PHP line-numbers">BEGIN;

CREATE SEQUENCE "spy_sales_order_totals_pk_seq";

CREATE TABLE "spy_sales_order_totals"
(
  "id_sales_order_totals" INTEGER NOT NULL,
  "fk_sales_order" INTEGER DEFAULT 0 NOT NULL,
  "subtotal" INTEGER DEFAULT 0,
  "order_expense_total" INTEGER DEFAULT 0,
  "discount_total" INTEGER DEFAULT 0,
  "grand_total" INTEGER DEFAULT 0,
  "refund_total" INTEGER DEFAULT 0,
  "canceled_total" INTEGER DEFAULT 0,
  "tax_total" INTEGER DEFAULT 0,
  "created_at" TIMESTAMP,
  "updated_at" TIMESTAMP,
  PRIMARY KEY ("id_sales_order_totals")
);

ALTER TABLE "spy_sales_expense"

  ADD "net_price" INTEGER DEFAULT 0,

  ADD "price" INTEGER DEFAULT 0,

  ADD "discount_amount_aggregation" INTEGER DEFAULT 0,

  ADD "tax_amount" INTEGER DEFAULT 0,

  ADD "refundable_amount" INTEGER DEFAULT 0,

  ADD "price_to_pay_aggregation" INTEGER DEFAULT 0,

  ADD "tax_amount_after_cancellation" INTEGER DEFAULT 0;

ALTER TABLE "spy_sales_order"

    ADD "price_mode" INT2;

ALTER TABLE "spy_sales_order_item"

  ADD "net_price" INTEGER DEFAULT 0,

  ADD "price" INTEGER DEFAULT 0,

  ADD "subtotal_aggregation" INTEGER,

  ADD "tax_amount" INTEGER DEFAULT 0,

  ADD "tax_amount_full_aggregation" INTEGER DEFAULT 0,

  ADD "tax_rate_average_aggregation" NUMERIC(8,2),

  ADD "tax_amount_after_cancellation" INTEGER DEFAULT 0,

  ADD "product_option_price_aggregation" INTEGER DEFAULT 0,

  ADD "expense_price_aggregation" INTEGER DEFAULT 0,

  ADD "discount_amount_aggregation" INTEGER DEFAULT 0,

  ADD "discount_amount_full_aggregation" INTEGER DEFAULT 0,

  ADD "price_to_pay_aggregation" INTEGER DEFAULT 0,

  ADD "refundable_amount" INTEGER DEFAULT 0;

ALTER TABLE "spy_sales_order_item_bundle"

  ADD "net_price" INTEGER DEFAULT 0,

  ADD "price" INTEGER DEFAULT 0;

ALTER TABLE "spy_sales_order_item_option"

  ADD "net_price" INTEGER DEFAULT 0,

  ADD "price" INTEGER DEFAULT 0,

  ADD "discount_amount_aggregation" INTEGER DEFAULT 0,

  ADD "tax_amount" INTEGER DEFAULT 0;

ALTER TABLE "spy_sales_order_totals" ADD CONSTRAINT "spy_sales_order_totals-fk_sales_order"
FOREIGN KEY ("fk_sales_order")
REFERENCES "spy_sales_order" ("id_sales_order");

COMMIT;
</code></pre>
                                                                        </div>
                                                                    </div>
                                                                    <ol start="3">
                                                                        <li value="3">Run console commands:</li>
                                                                    </ol>
                                                                    <ul>
                                                                        <li value="1"><var>vendor/bin/console transfer:generate</var>
                                                                        </li>
                                                                        <li value="2"><var>vendor/bin/console propel:diff</var>
                                                                        </li>
                                                                        <li value="3"><var>vendor/bin/console propel:model:build</var>
                                                                        </li>
                                                                    </ul>
                                                                    <p class="tip">You should now be able to persist an order with the new calculated values.</p>
                                                                    <h4>Sales Aggregation</h4>
                                                                    <p>SalesAggregation is no longer needed as we persist all calculated values.</p>
                                                                    <p>Because SalesAggregator is not used, we added a new extension point when the order is read. At this point, you can enrich <var>OrderTransfer </var>with your own data.</p>
                                                                    <p><var>\Spryker\Zed\Sales\Dependency\Plugin\HydrateOrderPluginInterface</var> provides a new plugin interface to inject more data for an order.</p>
                                                                    <p>See  for more information about the hydration plugins. There is also a list of "required by default" plugins.</p>
                                                                    <p>For out-of-the-box projects the following plugins should be configured as described below.</p>
                                                                    <p>Create class <var>Pyz\Zed\Sales\SalesDependencyProvider</var>, if not already created. Add the new method <var>SalesDependencyProvider::getOrderHydrationPlugins</var>.</p>
                                                                    <p>Include two new hydrator plugins:</p><pre><code class="language-PHP line-numbers">&lt;?php
    namespace Pyz\Zed\Sales;

    use Spryker\Zed\Sales\SalesDependencyProvider as SprykerSalesDependencyProvider;
    use Spryker\Zed\Discount\Communication\Plugin\Sales\DiscountOrderHydratePlugin;
    use Spryker\Zed\ProductOption\Communication\Plugin\Sales\ProductOptionOrderHydratePlugin;

    class SalesDependencyProvider extends SprykerSalesDependencyProvider
    {
        /**
         * @return array|/Spryker/Zed/Sales/Dependency/Plugin/HydrateOrderPluginInterface[]
         */
        protected function getHydrateOrderPlugins()
        {
            return [
                new ProductOptionOrderHydratePlugin(),
                new DiscountOrderHydratePlugin(),
            ];
        }
    }
?&gt;    </code></pre>
                                                                    <p>After this, when you read an order using <var>SalesFacade::getOrderByIdSalesOrder()</var>, the above mentioned plugins will be called to populate the order with additional data,  in this case ProductOptions and Discounts.</p>
                                                                    <p class="note">The Sales module does not depend on the <var>SalesAggregator</var> anymore. Therefore, you need to remove the <var>/sales-aggregator/sales/list</var> from <var>\Pyz\Zed\Sales\SalesConfig::getSalesDetailExternalBlocksUrls </var>as it is no longer in use. Totals were moved to Sales to the template <var>Spryker/Zed/Sales/Presentation/Detail/boxes/totals.twig</var> available in Sales version &gt;= 6.*.</p>
                                                                    <h4>Template Changes in SalesBundle &gt;= 6.*:</h4>
                                                                    <p>Item and Item option display have been split into three separate template files:</p>
                                                                    <ol>
                                                                        <li value="1"><var>Spryker/Zed/Sales/Presentation/Detail/boxes/order-item.twig</var>
                                                                        </li>
                                                                        <li value="2"><var>Spryker/Zed/Sales/Presentation/Detail/boxes/order-item-option.twig</var>
                                                                        </li>
                                                                        <li value="3"><var>Spryker/Zed/Sales/Presentation/Detail/boxes/items.twig</var>
                                                                        </li>
                                                                    </ol>
                                                                    <p>If you have modified these files, take into consideration how data formatting has changed. You will need to adapt your templates accordingly.</p>
                                                                    <p>Also, update your <var>CheckoutDependency</var> provider to include the new expander plugin, which is registered in the new checkout preSave plugin, see <a href="https://documentation.spryker.com/capabilities/checkout/multi-step_checkout/checkout-process-201903.htm">Checkout Process.</a></p>
                                                                    <p>This plugin expands quote items so each item has a single quantity, then runs order recalculate to have correctly distributed amounts. This is needed because after split has been made, some items may have rounding errors and we need to make sure that the tax and price to pay values are correct.</p>
                                                                    <p><strong>To add a new plugin to \Pyz\Zed\Checkout\CheckoutDependencyProvider</strong>:</p><pre><code class="language-PHP line-numbers">&lt;?php

   /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Checkout\Dependency\Plugin\CheckoutPreSaveHookInterface[]
     */
    protected function getCheckoutPreSaveHooks(Container $container)
    {
        return [
            new SalesOrderExpanderPlugin()
        ];
    }
</code></pre>
                                                                </div>
                                                            </div>
                                                            <h2>Old Order Migration</h2>
                                                            <p>To migrate old orders, use the deprecated <var>SalesAggregator</var> to populate the new table columns.</p>
                                                            <p><var>SalesAggregator</var> has been deprecated and will be removed in the future. Till then, we will still provide future patches for it.</p>
                                                            <p>All <var>SalesAggregator</var> plugins were moved to the SalesAggregator module.</p>
                                                            <p>The final core plugins list is:</p><pre><code class="language-PHP line-numbers">&lt;?php
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\DiscountTotalAmountWithProductOptionsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ItemsWithProductOptionsAndDiscountsTaxAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderDiscountsWithProductOptionsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderTaxAmountWithProductOptionsAndDiscountsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ProductOptionDiscountsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ExpenseTotalAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\GrandTotalAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ItemGrossPriceAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ItemTaxAmountAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderExpenseTaxAmountAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\SubtotalOrderAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ProductOptionsGrossPriceAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\SubtotalWithProductOptionsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\DiscountTotalAmountAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\ItemDiscountsOrderAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderDiscountsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderExpensesWithDiscountsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderExpenseTaxWithDiscountsAggregatorPlugin;
use Spryker\Zed\SalesAggregator\Communication\Plugin\OrderAmountAggregator\OrderGrandTotalWithDiscountsAggregatorPlugin;
?&gt;</code></pre>
                                                            <p>If you want to receive future patches for the related plugins, it's recommended that you update all your used statements to point to the SalesAggregator module.</p>
                                                            <p>The modules <var>ProductOption</var>, <var>DiscountSalesAggregatorConnector</var>, <var>DiscountSalesAggregatorConnector </var>no longer store Aggregator plugins.</p>
                                                            <div class="MCDropDown MCDropDown_Closed dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" /><div class="drop-anchor">Old Order Migration Guide</div></a></span>
                                                                <div class="MCDropDownBody dropDownBody">
                                                                    <p>Use this guide as a reference when preparing migration script.</p>
                                                                    <p class="important">Before beginning, make a backup of your sales order data!</p>
                                                                    <h4>Console Command</h4>
                                                                    <p>We prepared a migration console command which will  populate your old orders with the new calculated values.</p>
                                                                    <p>To download this console command, go to <a href="mg-sales-aggregator.htm#Console" class="MCXref xref">Migration Guide - SalesAggregator    </a>.</p>
                                                                    <p>Register the following console command: <var>\Pyz\Zed\SalesAggregator\Communication\Console\SalesAggregatorMigrationConsole</var> in the Spryker Console module dependency provider: <var>\Pyz\Zed\Console\ConsoleDependencyProvider::getConsoleCommands</var> method.</p><pre><code class="language-PHP line-numbers">&lt;?php
/**
  * @param \Spryker\Zed\Kernel\Container $container
  *
  * @return \Symfony\Component\Console\Command\Command[]
  */
 public function getConsoleCommands(Container $container)
 {
    $commands = [
      ...
      new SalesAggregatorMigrationConsole(),
    ];
 }

?&gt;
</code></pre>
                                                                    <p class="important">**Please backup your data now!**</p>
                                                                    <p>You can now execute the command via <var>vendor/bin/console sales-aggregator:migrate</var> - you will be prompted to confirm before executing the migration.</p>
                                                                    <p>Console command accepts an argument to make "dry run" by verifying if all data is correct, it compares aggregated and new calculated values.</p>
                                                                    <p>If any order fails verification, it will be skipped and you will have to manually investigate and fix it.</p>
                                                                    <p>Verification checks if values are still the same before/after the migration.</p>
                                                                    <p>After the migration is complete, you can drop all use of <var>SalesAggregator</var>, as all values are already persisted. You can get the same results by using <var>SalesFacade::getOrderByIdSalesOrder()</var>.</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p>&#160;</p>
                                                    <p><b>See also:</b>
                                                    </p>
                                                    <ul>
                                                        <li value="1"><a href="https://documentation.spryker.com/capabilities/cart/calculation/calculation.htm">Get a general idea about calculation and how it works</a>
                                                        </li>
                                                        <li value="2"><a href="https://documentation.spryker.com/capabilities/cart/calculation/calculation-data-structure.htm">Learn about Calculation Data Structure</a>
                                                        </li>
                                                        <li value="3"><a href="https://documentation.spryker.com/capabilities/cart/calculation/calculation-plugins.htm">Check Calculation Plugins</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div><a class="scroll-top js-scroll-top" href="#"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill="#FFF" fill-rule="nonzero" d="M11.82 5.22a.54.54 0 0 1 0 .806.636.636 0 0 1-.852 0L6.607 1.937v13.49a.587.587 0 0 1-.602.573c-.336 0-.611-.258-.611-.573V1.937L1.04 6.026a.647.647 0 0 1-.86 0 .54.54 0 0 1 0-.807L5.573.163a.636.636 0 0 1 .852 0L11.82 5.22z" /></svg></a>
                                <script>/* <![CDATA[ */
			function createGithubUrl() {
			var GITHUB_CONTENT_PATH = '/blob/master/public';
			var link = document.querySelector('.js-widget-github-link');
			var href =
			link.getAttribute('href')
			+ GITHUB_CONTENT_PATH
			+ window.location.pathname;
			link.setAttribute('href', href);
			}
			createGithubUrl();
		/* ]]> */</script>
                                <script>/* <![CDATA[ */
			requirejs.config({
				appDir: '',
				paths: {
					'clipboard': ['https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min']
					
				}
			});
			require(['clipboard'], function(Clipboard) {
				console.log(Clipboard);
				window.Clipboard = Clipboard;
			});
		/* ]]> */</script>
                                <script src="../resources/scripts/perfect-scrollbar.js">
                                </script>
                                <script src="../resources/scripts/imagemapster.js">
                                </script>
                                <script src="../resources/scripts/script.js">
                                </script>
                                <script src="../resources/scripts/prism.js">
                                </script>
                            </div>
                        </div>
                    </section><a data-close="true"></a>
                </div>
            </div>
            <script>/* <![CDATA[ */$(document).foundation();/* ]]> */</script>
        </div>
    </body>
</html>
