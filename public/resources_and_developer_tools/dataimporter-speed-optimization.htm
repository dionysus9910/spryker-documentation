<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="_Skins_HTML5___Top_Navigation" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../" data-mc-has-content-body="True" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Back-End|Resources and Developer Tools">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="msapplication-config" content="../Skins/Favicons/browserconfig.xml" />
        <meta name="description" content="Importing big amount of data into a system can pose a real problem. When not optimized, the importing process will most likely be slow." />
        <link rel="apple-touch-icon" sizes="180x180" href="../Skins/Favicons/apple-touch-icon.png" />
        <link rel="shortcut icon" href="../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="96x96" href="../Skins/Favicons/favicon-96x96.png" />
        <link rel="icon" sizes="32x32" href="../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="16x16" href="../Skins/Favicons/favicon-16x16.png" />
        <meta charset="utf-8" />
        <meta name="description" content="" />
        <meta name="author" content="" /><title>Dataimporter Speed Optimization | Spryker</title>
        <!-- Google Tag Manager -->
        <script>/* <![CDATA[ */(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=
			'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-NP24S2');/* ]]> */</script>
        <!-- End Google Tag Manager -->
        <script>/* <![CDATA[ */
			var s = document.createElement("script");
			s.type = "text/javascript";
			s.src = "https://www.googletagmanager.com/gtag/js?id==UA-56589105-4";
			document.getElementsByTagName('head').item(0).appendChild(s);
		/* ]]> */</script>
        <script>/* <![CDATA[ */
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-56589105-4');
		/* ]]> */</script>
        <link href="../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/foundation.6.2.3.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/styles.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/tablet.css" rel="stylesheet" />
        <link href="../Skins/Fluid/stylesheets/mobile.css" rel="stylesheet" />
        <link href="../resources/stylesheets/perfect-scrollbar.css" rel="stylesheet" />
        <link href="../resources/stylesheets/prism.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.previous-topic-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/navigate-previous.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.next-topic-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/navigate-next.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../resources/scripts/PIE-no-motw.htc');
}

</style>
        <link href="../resources/stylesheets/mainstyles.css" rel="stylesheet" />
        <script src="../resources/scripts/custom.modernizr.js">
        </script>
        <script src="../resources/scripts/jquery.min.js">
        </script>
        <script src="../resources/scripts/require.min.js">
        </script>
        <script src="../resources/scripts/require.config.js">
        </script>
        <script src="../resources/scripts/foundation.6.2.3_custom.js">
        </script>
        <script src="../resources/scripts/plugins.min.js">
        </script>
        <script src="../resources/scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="small" data-mc-ignore="true">
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <button class="menu-icon" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../home.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form class="search" action="#">
                                            <div class="search-bar search-bar-container needs-pie">
                                                <input class="search-field needs-pie" type="search" placeholder="Search the Academy" />
                                                <div class="search-filter-wrapper">
                                                    <div class="search-filter">
                                                        <div class="search-filter-content">
                                                            <ul>
                                                                <li>All Files</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="search-submit-wrapper" dir="ltr">
                                                    <div class="search-submit" title="Search">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <section class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <div class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </div>
                            <div class="body-container" data-mc-content-body="True">
                                <!-- Google Tag Manager (noscript) -->
                                <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP24S2" height="0" width="0" style="display:none;visibility:hidden"></iframe>
                                </noscript>
                                <!-- End Google Tag Manager (noscript) -->
                                <div class="search-container">
                                    <form class="search" action="#">
                                        <div class="search-bar search-bar-container needs-pie _Skins_SearchTopics mc-component">
                                            <input class="search-field needs-pie" type="search" placeholder="Search" />
                                            <div class="search-filter-wrapper">
                                                <div class="search-filter">
                                                    <div class="search-filter-content">
                                                        <ul>
                                                            <li>All Files</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="search-submit-wrapper" dir="ltr">
                                                <div class="search-submit" title="Search">
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="row collapse">
                                    <div class="top-bar">
                                        <div class="breadcrumbs-block">
                                            <div class="nocontent">
                                                <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                        </div>
                                        <form class="search" action="#">
                                            <div class="search-bar search-bar-container needs-pie _Skins_SearchHome mc-component">
                                                <input class="search-field needs-pie" type="search" placeholder="Search" />
                                                <div class="search-filter-wrapper">
                                                    <div class="search-filter">
                                                        <div class="search-filter-content">
                                                            <ul>
                                                                <li>All Files</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="search-submit-wrapper" dir="ltr">
                                                    <div class="search-submit" title="Search">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="topic-layout">
                                        <div>
                                            <div class="side-menu">
                                                <div data-sticky-container="" id="eqBZrVp4B0evlNYuKPkbJw">
                                                    <div class="sticky sticky-menu" style="width:100%" data-sticky="" data-top-anchor="eqBZrVp4B0evlNYuKPkbJw:top" data-bottom-anchor="contentBody:bottom" data-sticky-on="small" data-scroll-container-on="small">
                                                        <ul class="nocontent menu _Skins_SideMenu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/master.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="side-menu">
                                                <div class="toolbar-wrapper">
                                                    <div class="widget-github js-widget-github"><a class="widget-github-link js-widget-github-link" href="https://github.com/spryker/spryker-documentation" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M13.5 0C6.057 0 0 6.057 0 13.5c0 5.888 3.791 10.905 9.058 12.745a.463.463 0 0 0 .258.088c1.316.43 2.724.667 4.184.667C20.943 27 27 20.943 27 13.5S20.943 0 13.5 0zm0 .931c6.93 0 12.569 5.639 12.569 12.569 0 5.428-3.459 10.061-8.287 11.818a1.903 1.903 0 0 1-.092-.527v-2.446c0-.975-.477-2.037-.946-2.75 2.584-.436 5.537-1.776 5.537-6.779 0-1.37-.429-2.58-1.275-3.598.186-.611.415-1.9-.225-3.52a.47.47 0 0 0-.291-.272c-.13-.04-1.326-.35-3.806 1.277a12.921 12.921 0 0 0-6.36 0c-2.481-1.63-3.68-1.319-3.809-1.277a.47.47 0 0 0-.29.273C5.582 7.319 5.811 8.607 6 9.218c-.85 1.018-1.279 2.227-1.279 3.598 0 4.957 2.9 6.323 5.463 6.778-.322.407-.66.934-.81 1.47-.661.184-2.018.19-2.929-1.37-.032-.06-.829-1.475-2.4-1.584-.25.002-.882.042-1.035.525-.169.537.424.944.679 1.117l.058.034c.029.015.707.371 1.213 1.644.105.333 1.03 2.84 4.353 2.399.002.367 0 .552-.004.7v.26c0 .15-.045.378-.096.525C4.386 23.558.931 18.924.931 13.5.931 6.57 6.57.931 13.5.931zm6.51 5.375c.5 1.471.158 2.537.035 2.839a.468.468 0 0 0 .089.49c.805.883 1.214 1.952 1.214 3.181 0 4.72-2.796 5.666-5.535 5.97a.464.464 0 0 0-.253.815c.368.314 1.199 1.68 1.199 2.744v2.446c0 .009.001.414.134.809a12.513 12.513 0 0 1-6.792-.002c.135-.396.139-.802.139-.81l.001-.248c.002-.211.006-.497 0-1.266a.473.473 0 0 0-.174-.362.47.47 0 0 0-.391-.09c-3.126.681-3.802-1.576-3.828-1.67l-.016-.047c-.448-1.135-1.037-1.713-1.388-1.975.759.267 1.182 1.007 1.193 1.024 1.231 2.107 3.264 2.162 4.328 1.685a.463.463 0 0 0 .27-.36c.095-.665.826-1.545 1.196-1.87a.464.464 0 0 0 .136-.488.461.461 0 0 0-.39-.324c-2.73-.31-5.524-1.266-5.524-5.98 0-1.228.41-2.3 1.219-3.181a.464.464 0 0 0 .087-.491c-.124-.302-.467-1.364.031-2.837.396.013 1.362.182 2.988 1.286.112.076.256.1.387.063.973-.27 2.058-.416 3.135-.421 1.08.005 2.166.15 3.14.421.131.037.273.013.386-.063 1.635-1.11 2.6-1.275 2.984-1.288z" /></svg></a>
                                                    </div>
                                                    <div class="buttons popup-container clearfix topicToolbarProxy _Skins_TopicToolbar mc-component nocontent" style="mc-topic-toolbar-items: PreviousTopic NextTopic Print ExpandAll CollapseAll;">
                                                        <div class="button-group-container-left">
                                                            <button class="button needs-pie previous-topic-button" title="Navigate previous">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="previous topic" />
                                                            </button>
                                                            <button class="button needs-pie next-topic-button" title="Navigate next">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="next topic" />
                                                            </button>
                                                            <button class="button needs-pie print-button" title="Print">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                                            </button>
                                                            <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                                                <img src="../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="js-anchorer main-content">
                                                    <h1>Data Importer Speed Optimization</h1>
                                                    <h2>Concept</h2>
                                                    <p style="font-weight: bold;">"Writing code is the easy part of every feature but writing a scalable and fast solution is a challenge"</p>
                                                    <p>This article will define the best practices for Spryker modules that need to work with two infrastructure concepts like DataImport and Publish &amp; Synchronize. After several reviews and tests, we found that we need to define these rules to help developers to write more scalable and high-performance code when they implementing their features. Most of the time when developers create features, they don't consider very high traffic or heavy data processing for big data. This article is going to describe all necessary requirements when you want to create new features and they should work with big data, for example, you want to create a new <var>DataImport</var> or a new P&amp;S module which save millions of entities into a database in a very short amount of time.</p>
                                                    <h2>Rules for Data Importers</h2>
                                                    <p><var>DataImport</var> module is responsible for reading data from different formats like CSV, JSON, etc and import them into a database with proper Spryker data structure. Usually importing of data is a time-consuming process and we need to follow some best practices to increase the performance. Here you will find some of them:</p>
                                                    <h3>Single vs Batch operation</h3>
                                                    <p>Assuming you are writing a data importer for ProductAbstract, you might want to find a category for each product abstract, your very basic code would be something like this:</p><pre><code class="language-PHP line-numbers">protected function importProductAbstract(DataSetInterface $dataSet): void
{
	$categoryKey = $dataSet['category_key'];
	$productCategory = SpyCategoryQuery::create()-&gt;findOneByCategoryKey($categoryKey);
	$dataSet['product_category'] = $productCategory;
      
	$this-&gt;importProductCategories($dataSet);
}</code></pre>
                                                    <p>This will work fine and you already achieved to your goals, but can you see the problem here?</p>
                                                    <p>Here is the problem:</p><pre xml:space="preserve"><code class="language-PHP line-numbers">protected function importProductAbstract(DataSetInterface $dataSet): void
{
	...
	$productCategory = SpyCategoryQuery::create()-&gt;findOneByCategoryKey($categoryKey); // expensive call
	...
}</code></pre>
                                                    <p><var>importProductAbstract</var> method will call for each line of your CSV, imagine if you have one CSV file with 1,000,000 lines, it means you will run this query again and again for 1 million times! The possible solution is to avoid single processing and implementing a batch query for it.</p>
                                                    <p>The current solution for <var>DataImport</var> is to add another step before the main step to gather all the information you need for the next steps. Like querying all categories and remember them in memory and the next step can do a fast PHP look up from that result in memory.</p>
                                                    <p class="note">DataImport v1.4.x doesn't support the batch processing by default and the next version will provide a very clear solution for it.</p>
                                                    <h3>ORM vs PDO</h3>
                                                    <p>ORM (Object-relational mapping) is a very good approach when we are working on very big and complex software but it's not always the answer to all problems especially when it comes to batch processing. ORM is slow by design as they need to handle so many internal hydration and mapping.</p>
                                                    <p>Here is an example of using the Propel ORM, this is a very clean and nice approach but not optimized enough for importing big data.</p><pre xml:space="preserve"><code class="language-PHP line-numbers">protected function createOrUpdateProductAbstract(DataSetInterface $dataSet): SpyProductAbstract
{
	$productAbstractEntityTransfer = $this-&gt;getProductAbstractTransfer($dataSet);
  
	$productAbstractEntity = SpyProductAbstractQuery::create()
		-&gt;filterBySku($productAbstractEntityTransfer-&gt;getSku())
		-&gt;findOneOrCreate()
		-&gt;save()
	;
  
	return $productAbstractEntity;
}</code></pre>
                                                    <p>This approach has two problems</p>
                                                    <ol>
                                                        <li value="1">It runs <b>two</b> queries, one <b>SELECT</b> for <var>findOneOrCreate</var> and one <b>INSERT</b> or <b>UPDATE</b> for <var>save</var></li>
                                                        <li value="2">Single process approach (repeated per each entry)</li>
                                                    </ol>
                                                    <p>Solution is</p>
                                                    <ol>
                                                        <li value="1">Avoid ORM, you can use a very simple raw SQL but you should also avoid complex raw or big raw SQL queries.</li>
                                                        <li value="2">Implement DataSetWriterInterface to achieve the batch processing approach, prepare one by one and write them once (Take a look at <var>ProductAbstractWriter</var> in <var>Dataimport</var> as an example)</li>
                                                    </ol>
                                                    <h3>Facade Calls</h3>
                                                    <p>Sometimes you may need to run some validation or business logic for each data set, the easiest and safest way would be a Facade API call, that's totally fine, but then imagine if these APIs also call some heavy queries very deep! this has a huge side effect on your performance during importing millions of data.</p>
                                                    <p>Here you can see for each product stock, there are two facade calls, each facade call may run more than 5 queries, this means for importing 1,000,000 data, you will have 10,000,000 queries! (this will never finish!).</p><pre xml:space="preserve"><code class="language-PHP line-numbers">protected function updateBundleAvailability(): void
{
	foreach (static::$stockProductCollection as $stockProduct) {
		if (!$stockProduct[ProductStockHydratorStep::KEY_IS_BUNDLE]) {
			continue;
		}
		$this-&gt;productBundleFacade-&gt;updateBundleAvailability($stockProduct[ProductStockHydratorStep::KEY_CONCRETE_SKU]);
		$this-&gt;productBundleFacade-&gt;updateAffectedBundlesAvailability($stockProduct[ProductStockHydratorStep::KEY_CONCRETE_SKU]);
	}
}</code></pre>
                                                    <p>The solution is:</p>
                                                    <ol>
                                                        <li value="1">Implement a new Facade API for batch operation</li>
                                                        <li value="2">Only call facade if they are very lightweight and they don't run any query to a database</li>
                                                    </ol>
                                                    <h3>Memory Management</h3>
                                                    <p>Let's say you already started to work with the batch operation, one of the challenges would be to keep the memory as low as possible. Sometimes you create variables and try to remember them always, but you may need them only until the end of the batch operation, so it's better to release them as soon as possible.</p>
                                                    <h3>Database Vendor Approach</h3>
                                                    <p>In Spryker we are supporting both PostgreSQL and MySQL, both are very powerful and come with very promising and handy features. When we are working with databases, it's always good to know these features, one of the very cool features that we like is <a href="https://www.postgresql.org/docs/9.1/queries-with.html">CTE</a>. If you think you are inserting or updating very big data like millions of millions, use CTE as a replaceable for multiple inserts/update. you can find some of Spryker implementation in our demo shops.</p>
                                                    <h2>Rules for Publish and Synchronize</h2>
                                                    <p>P&amp;S is a concept for transferring data from Zed database to Yves databases like Redis and ES, This operation is separated into two isolated processes which call <b>Publish</b> and <b>Synchronize</b>. Publishing is a process to aggregating data and writing it to Database and Queue. Synchronization is a process to read an aggregated message from a queue and write it to external endpoints. The performance issues mostly come from <b>Publishing</b> part. Again we need to follow the best practices to increase the performance. Here you will find some of them:</p>
                                                    <h3>Single vs Batch operation</h3>
                                                    <p>When you are creating a new listener you should consider these rules:</p>
                                                    <ul>
                                                        <li value="1">Run your logic against a chunk of event messages not per each.</li>
                                                        <li value="2">Don't run the query inside of <var>for-loop</var></li>
                                                        <li value="3">Try to save them with a bulk operation, not one by one</li>
                                                    </ul>
                                                    <p>Take a look at this example:</p><pre xml:space="preserve"><code class="language-PHP line-numbers">public function publish(array $productAbstractIds): void
{
	foreach ($productAbstractIds as $idProductAbstract) {
		$productAbstractProductListStorageEntity = $this-&gt;queryProductAbstractProductListEntity($idProductAbstract);
	}
  
}</code></pre>
                                                    <p>Here we are passing a set of ids and then we try to run a query for each product abstract. Imagine if you have 2000 events as a chunk, then you have 2000 queries to a database.</p>
                                                    <p>We can easily fix this by changing the query and run query only once per 2000 ids.</p><pre xml:space="preserve"><code class="language-PHP line-numbers">public function publish(array $productAbstractIds): void
{
	$productAbstractProductListStorageEntities = $this-&gt;queryProductAbstractProductListEntities($productAbstractIds);
}</code></pre>
                                                    <h3>Facade Calls</h3>
                                                    <p>Another point that we need to be very careful here is to call Facade API without any thinking through, we must make sure that these APIs will not run queries inside same as <var>DataImport</var> rule. You are allowed to call Facade API but if:</p>
                                                    <ul>
                                                        <li value="1">There is no query inside</li>
                                                        <li value="2">Facade API designed for batch operation (<var>findPriceForSku</var> vs <var>findPricesForSkus</var>)</li>
                                                    </ul>
                                                    <h3>Triggering Events</h3>
                                                    <p>Data Importers are triggering events manually, this is happening because of performance reasons :</p>
                                                    <ol>
                                                        <li value="1">Triggering events automatically will generate so many duplicates events during data importing, (e.g: Inserting a Product into <var>spy_product</var> and <var>spy_product_localized_attrbite</var> table will generate two events with the same <var>id_product</var>).</li>
                                                        <li value="2">Events will be triggered one by one.</li>
                                                    </ol>
                                                    <p>You can always switch the Event Triggering process with two methods:</p><pre xml:space="preserve"><code class="language-PHP line-numbers">use Spryker\Zed\EventBehavior\EventBehaviorConfig;
...
  
	public function foo()
	{
		/**
		 * Disable the events triggering automatically
		 */
		EventBehaviorConfig::disableEvent();
  
		// 1.Create many entities in multiple tables (e.g API bulk import, nightly update jobs)
		// 2.Trigger proper events if it's necessary ($eventFacade-&gt;triggerBulk('ProductAbstractPublish', $eventTransfers))
  
		/**
		 * Enable the events triggering automatically
		 */
		EventBehaviorConfig::enableEvent();
	}</code></pre>
                                                    <h3>P&amp;S and CTE</h3>
                                                    <p>Sometimes the amount of the data which needs be synced is very high, for this reason, we can not rely on a standard ORM solution for storing data in the database tables. we recommend you to use bulk insert operation whenever you have more than hundreds of thousand of data. you can still use the CTE technique which was used in DataImporter before. Spryker suite comes with several examples of using CTE technique in Storage and Search module you can replace them by overwriting the Business Factory in the modules:</p>
                                                    <p class="note">These examples only tested for PostgreSQL.</p>
                                                    <ul>
                                                        <li value="1"><var>src/Pyz/Zed/PriceProductStorage/Business/Storage/PriceProductAbstractStorageWriter.php</var>
                                                        </li>
                                                        <li value="2"><var>src/Pyz/Zed/PriceProductStorage/Business/Storage/PriceProductConcreteStorageWriter.php</var>
                                                        </li>
                                                        <li value="3"><var>src/Pyz/Zed/ProductPageSearch/Business/Publisher/ProductAbstractPagePublisher.php</var>
                                                        </li>
                                                        <li value="4"><var>src/Pyz/Zed/ProductPageSearch/Business/Publisher/ProductConcretePageSearchPublisher.php</var>
                                                        </li>
                                                        <li value="5"><var>src/Pyz/Zed/ProductStorage/Business/Storage/ProductAbstractStorageWriter.php</var>
                                                        </li>
                                                        <li value="6"><var>src/Pyz/Zed/ProductStorage/Business/Storage/ProductConcreteStorageWriter.php</var>
                                                        </li>
                                                        <li value="7"><var>src/Pyz/Zed/UrlStorage/Business/Storage/UrlStorageWriter.php</var>
                                                        </li>
                                                    </ul>
                                                    <p>Example classes are going to be replaced with a Core CTE solution.</p>
                                                    <h2>Conclusion</h2>
                                                    <p>When we are facing some batch operation, we need to think about big data and performance under heavy loading, we are not allowed to write same code that only does the job, it needs to be scalable and fast for high usages. here you can find our main points</p>
                                                    <ul>
                                                        <li value="1">Create batch queries and processes</li>
                                                        <li value="2">Don’t use ORM for batch processing as it’s slow by design</li>
                                                        <li value="3">Don’t run separated queries for each data-set</li>
                                                        <li value="4">Don’t call any facade logic if they are slow or run internal queries</li>
                                                        <li value="5">Release memory after each bulk operations to prevent memory issues</li>
                                                        <li value="6">Use CTE technique (supported by PostgreSQL and MySQL)</li>
                                                    </ul>
                                                    <p>&#160;</p>
                                                    <p><i>Last review date: Aug 12, 2019</i>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div><a class="scroll-top js-scroll-top" href="#"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill="#FFF" fill-rule="nonzero" d="M11.82 5.22a.54.54 0 0 1 0 .806.636.636 0 0 1-.852 0L6.607 1.937v13.49a.587.587 0 0 1-.602.573c-.336 0-.611-.258-.611-.573V1.937L1.04 6.026a.647.647 0 0 1-.86 0 .54.54 0 0 1 0-.807L5.573.163a.636.636 0 0 1 .852 0L11.82 5.22z" /></svg></a>
                                <script>/* <![CDATA[ */
			function createGithubUrl() {
			var GITHUB_CONTENT_PATH = '/blob/master/public';
			var link = document.querySelector('.js-widget-github-link');
			var href =
			link.getAttribute('href')
			+ GITHUB_CONTENT_PATH
			+ window.location.pathname;
			link.setAttribute('href', href);
			}
			createGithubUrl();
		/* ]]> */</script>
                                <script>/* <![CDATA[ */
			requirejs.config({
				appDir: '',
				paths: {
					'clipboard': ['https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min']
					
				}
			});
			require(['clipboard'], function(Clipboard) {
				console.log(Clipboard);
				window.Clipboard = Clipboard;
			});
		/* ]]> */</script>
                                <script src="../resources/scripts/perfect-scrollbar.js">
                                </script>
                                <script src="../resources/scripts/imagemapster.js">
                                </script>
                                <script src="../resources/scripts/script.js">
                                </script>
                                <script src="../resources/scripts/prism.js">
                                </script>
                            </div>
                        </div>
                    </section><a data-close="true"></a>
                </div>
            </div>
            <script>/* <![CDATA[ */$(document).foundation();/* ]]> */</script>
        </div>
    </body>
</html>
