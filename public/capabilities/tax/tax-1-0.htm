<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="Spryker.B2C,Spryker.B2B">
    <head>
    </head>
    <body>
        <h1>Tax Version 1.0 <img src="../../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../../Resources/Images/shoptype/B2C_Shop.png" /></h1>
        <p>
            <MadCap:relatedTopics target="_self" style="mc-label: 'Versions';mc-help-control-display: list;">
                <MadCap:relatedTopic src="tax-2-0.htm" />
            </MadCap:relatedTopics>
        </p>
        <p>The Tax module is responsible for handling tax rates that can apply for products, product options or shipment.</p>
        <h2><a name="Overview"></a>Overview</h2>
        <p>The tax sets can have different tax rates for each country defined in your shop. You can see in the diagram below how these entities are modeled in the database.</p>
        <p>
            <img src="../../Resources/Images/tax.png" title="Click me" alt="Tax database diagram" class="Thumbnail" />
        </p>
        <p>A tax set is defined by a name and is uniquely identified by an <var>id</var>. As its name says, it’s associated to a set of rates. A tax rate is defined by a name, a numeric rate value and it’s linked to a country.</p>
        <p>All in one, a tax set contains of collection of tax rates that apply by country.</p>
        <p>The <var>SpyTaxSetTax</var> table is used to model the many-to-many relation between tax set and tax rate tables.</p>
        <p class="info"><strong>Tax Related Entities</strong>
            <br />There are a couple of entities that have a tax set associated as a foreign key, such as abstract products, product options and shipment methods.</p>
        <h2><a name="Implemen"></a>Implementation Details</h2>
        <h3>TaxDefault Class</h3>
        <p><var>TaxDefault</var> class contains two important operations:</p>
        <ul>
            <li class="bullet_list">getDefaultTaxCountry() - retrieves the default tax country from the configuration file (e.g.: Germany).</li>
            <li class="bullet_list">getDefaultTaxRate() - retrieved the default tax rate from the configuration file (e.g.: 19%).</li>
        </ul>
        <p>These methods are called if the tax calculator cannot find the corresponding tax rate for one of the related entities.</p>
        <p>These methods can be extended on the project side, depending on your needs.</p>
        <h3>Calculator Plugins</h3>
        <p>Tax module ships with a set of calculator plugins, dedicated for calculating the taxes for each of the corresponding items in the <var>QuoteTransfer</var>.</p>
        <p>The calculators are called to recalculate the taxes every time <var>addToCart()</var> method is called or the payment step is entered. If the customer has changed the country during the address step, this is not an issue because the tax rates are recalculated.</p>
        <h4>Calculator Plugins for Tax Rates:</h4>
        <ul>
            <li class="bullet_list"><var>ProductItemTaxCalculatorsPlugin</var> - calculates tax rates based on <var>IdAbstractProduct</var> in the items contained in the <var>QuoteTransfer</var> (Tax module)</li>
            <li class="bullet_list"><var>ProductIOptionTaxCalculatorsPlugin</var> - calculated tax rates based on <var>IdOptionValueUsage</var> for every product option of the items contained in the QuoteTransfer (ProductOption module)</li>
            <li class="bullet_list"><var>ShipmentTaxCalculatorsPlugin</var> - calculates tax rates based on the shipment method set in the QuoteTransfer (Shipment module)</li>
        </ul>
        <p>The calculator plugins are registered in the <var>CalculationDependencyProvider:getCalculatorStack()</var> method.</p>
        <h2><a name="Extendin"></a>Extending Tax Module</h2>
        <p>One of the most common use cases of extending the Tax module is to provide a custom calculator.</p>
        <p>In the coding example below, we’ll implement a calculator that uses a flat tax rate for all the products.</p>
        <p>The new calculator plugin must extend the <var>AbstractPlugin</var> class and implement the <var>CalculatorPluginInterface</var>.</p>
        <p>In Zed, inside the <var>Tax/Communication/Plugin/</var> folder, create the <var>FlatTaxRateCalculatorPlugin</var> class.</p><pre><code class="language-PHP line-numbers">&lt;?php
...
use Generated\Shared\Transfer\QuoteTransfer;
use Spryker\Zed\Calculation\Dependency\Plugin\CalculatorPluginInterface;
use Spryker\Zed\Kernel\Communication\AbstractPlugin;
...
class NewTaxRateCalculatorPlugin extends AbstractPlugin implements CalculatorPluginInterface
{
...
   public function recalculate(QuoteTransfer $quoteTransfer)
    {
        $this-&gt;getFacade()-&gt;calculateProductItemTaxRate($quoteTransfer);
    }
}</code></pre>
        <p>Next, implement the business logic; create the <var>FlatTaxRateCalculator</var> inside the Model folder.</p><pre><code class="language-PHP line-numbers">&lt;?php
...

use Spryker\Zed\Tax\Persistence\TaxQueryContainer;
use Spryker\Zed\Tax\Persistence\TaxQueryContainerInterface;

class FlatTaxRateCalculator implements CalculatorInterface
{
    public function recalculate(QuoteTransfer $quoteTransfer)
    {
       //TODO implement new calculation ….
    }
}</code></pre>
        <p>Create a method that returns an instance of the calculator in the factory.</p><pre><code class="language-PHP line-numbers">&lt;?php
class TaxBusinessFactory extends AbstractBusinessFactory
{
    //..

    public function createProductItemTaxRateCalculator()
    {
        return new FlatTaxRateCalculator();
    }
}</code></pre>
        <p>Expose this functionality through the facade:</p><pre><code class="language-PHP line-numbers">&lt;?php
class TaxFacade extends AbstractFacade implements TaxFacadeInterface
{
    //..
   public function calculateFlatTaxRate(QuoteTransfer $quoteTransfer)
   {
        $this-&gt;getFactory()-&gt;createFlatTaxRateCalculator()-&gt;recalculate($quoteTransfer);
   }
}</code></pre>
        <p>Register the new plugin in the <var>CalculationDependencyProvide:getCalculatorStack()</var> method:</p><pre><code class="language-PHP line-numbers">&lt;?php
class CalculationDependencyProvider extends SprykerCalculationDependencyProvider
{
    protected function getCalculatorStack(Container $container)
    {
        return [
            new FlatTaxRateCalculatorPlugin(),
             ...
        ];
    }

}</code></pre>
        <h2><a name="Migratio"></a>Migration Guide</h2>
        <p>If you’re migrating the Tax module from version 2 to version 3, you need to follow the steps described in the <a href="http://documentation.spryker.com/module_migration_guides/mg-tax.htm" target="_blank">migration guide</a>.</p>
    </body>
</html>