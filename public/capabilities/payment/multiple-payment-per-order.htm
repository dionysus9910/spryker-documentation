<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:conditionTagExpression="include[Default.MC or Default.ML or Default.MS] " style="mc-master-page: url('..\..\Resources\MasterPages\OtherTopics.flmsp');" MadCap:conditions="Spryker.B2B,Spryker.B2C,Spryker.DemoShop,Spryker.MultiCurrency,Spryker.MultiLanguage,Spryker.ShopSuite,Spryker.MultiStore">
    <head>
    </head>
    <body>
        <h1>Multiple Payment Methods Per Order <img src="../../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../../Resources/Images/shoptype/B2C_Shop.png" /> <img src="../../Resources/Images/shoptype/MasterSuite.png" /> <img src="../../Resources/Images/shoptype/Demoshop.png" /></h1>
        <p>
            <MadCap:popup>
                <MadCap:popupHead>ML</MadCap:popupHead>
                <MadCap:popupBody>Multi-language</MadCap:popupBody>
            </MadCap:popup> <MadCap:popup><MadCap:popupHead>MS</MadCap:popupHead><MadCap:popupBody>Multi-store</MadCap:popupBody></MadCap:popup> <MadCap:popup><MadCap:popupHead>MC</MadCap:popupHead><MadCap:popupBody>Multi-currency</MadCap:popupBody></MadCap:popup></p>
        <p>All orders can be paid with none, one or multiple payment methods which the customer can select during checkout. To accommodate your customer's requirements, you can offer multiple payment methods for a single order, such as gift card and an additional credit card.
</p>
        <p>Most orders are paid with a single payment method but in same cases it is useful to allow multiple payment methods, for instance the customer may want to use two credit cards or he uses  gift card in addition to a traditional payment method.</p>
        <p>&#160;</p>
        <h2>Multiple Payments
</h2>
        <p>Spryker enables to have multiple payments per checkout, payments are stored in <var>QuoteTransfer::payments</var> and persisted when <var>CheckoutClient::placeOrder</var> is called in last checkout step.</p>
        <p>
Each payment method must provide payment amount it shares from order grand total. This amount is stored in <var>PaymentTransfer::amount</var> field. When order is placed in last step all payments are persisted to <var>spy_sales_payment</var> table.
</p>
        <h2>Payment Hydration for Order
</h2>
        <p>The <a href="../Order Management/Sales/sales.htm">Sales</a> module provides plugins to hydrate OrderTransfer which is called when <var>SalesFacade::getOrderByIdSalesOrder</var> invoked. </p>
        <p>One of those plugins are <var>\Spryker\Zed\Payment\Communication\Plugin\Sales\PaymentOrderHydratePlugin</var> which must be added to
<var>\Pyz\Zed\Sales\SalesDependencyProvider::getOrderHydrationPlugins</var> plugin stack. </p>
        <p>This plugin invokes the payment hydration plugin stack which must be injected to <var>\Spryker\Zed\Payment\PaymentDependencyProvider::PAYMENT_HYDRATION_PLUGINS</var>, for example:
</p>
        <p><pre><code class="language-PHP line-numbers">&lt;?php
namespace Spryker\Zed\PaymentProvider\Dependency\Injector;
class PaymentDependencyInjector extends AbstractDependencyInjector
{
    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Kernel\Container
     */
    public function injectBusinessLayerDependencies(Container $container)
    {
        $container = $this-&gt;injectPaymentPlugin($container);
        return $container;
    }
    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Kernel\Container
     */
    protected function injectPaymentPlugin(Container $container)
    {
        $container-&gt;extend(PaymentDependencyProvider::PAYMENT_HYDRATION_PLUGINS, function (PaymentHydratorPluginCollectionInterface $pluginCollection) {
             $pluginCollection-&gt;add(‘PaymentProvider’,  new PaymentProviderSalesOrderPaymentHydrationPlugin()) // this plugin must implement \Spryker\Zed\Payment\Dependency\Plugin\Sales\PaymentHydratorPluginInterface
             return $pluginCollection;
        });
        return $container;
    }
}
?&gt;
</code></pre>
        </p>
        <p>The plugin will receive <var>OrderTransfer</var> and <var>PaymentTransfer</var> which is the payment you need to hydrate with additional data. </p>
        <p>Plugins have to populate the <var>PaymentTransfer</var> object and return it back. After this step you should be able to get payment information when calling
<var>SalesFacade::getOrderByIdSalesOrder</var>.
We also included simple zed ui twig block for payments so it can display a little more information about payment methods used in order detail page. </p>
        <p><strong>To enable it go to</strong>:</p>
        <p><var>\Pyz\Zed\Sales\SalesConfig::getSalesDetailExternalBlocksUrls</var> and add <var>‘payments’ =&gt; ‘/payment/sales/list’,</var> to <var>$projectExternalBlocks</var> array.</p>
        <p>&#160;</p>
        <p><b>See also</b>: </p>
        <ul>
            <li><a href="http://documentation.spryker.com/module_migration_guides/mg-payment.htm">Payment Migration Guide</a>
            </li>
            <li><a href="dummy-payment.htm">Implement Dummy payment</a>
            </li>
        </ul>
        <p>&#160;</p>
    </body>
</html>