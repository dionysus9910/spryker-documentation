<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="General.Demoshop,Spryker.B2B,Spryker.B2C,Spryker.DemoShop">
    <head><title>Migration Guide - CMS Block</title>
    </head>
    <body>
        <h1>Migration Guide - CMS Block <img src="../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../Resources/Images/shoptype/B2C_Shop.png" /> <img src="../Resources/Images/shoptype/Demoshop.png" /></h1>
        <h2>Upgrading from Version 1.* to Version 2.*</h2>
        <p>This version allows to save CMS Block-Store relation.</p>
        <ol>
            <li>Update <var>spryker/cms-block</var> module to at least Version 2.0.0.</li>
            <li>
                Update your <var>spryker/cms-block-collector</var> module to at least Version 2.0.0.
                You can find additional guide to migration <a href="mg-cms-block-collector.htm"><a name="here"></a>here</a>.
                <MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot><div class="drop-anchor">Custom CMS Block Collector</div></MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody>
                        If you have a custom CMS Block Collector, make sure that it collects CMS Blocks only when the related CMS Block has an entity in the <var>spy_cms_block_store</var> table for the desired store.
                    </MadCap:dropDownBody></MadCap:dropDown></li>
            <li>
                Run <var>vendor/bin/console transfer:generate</var> to update and generate transfer object changes.
                <MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot><div class="drop-anchor">Transfer object changes</div></MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><ul><li><var>CmsBlock</var> transfer object has now a <var>StoreRelation</var> property which allows to retrieve/define the stores assigned to the current CMS Block.</li></ul></MadCap:dropDownBody></MadCap:dropDown></li>
            <li>Install the database changes by running <var>vendor/bin/console propel:diff</var>. Propel should generate a migration file with the changes.</li>
            <li>Apply the database changes: <var>vendor/bin/console propel:migrate</var>.</li>
            <li>Generate and update ORM models: <var>vendor/bin/console propel:model:build</var>.</li>
            <li>
                    You will find some new classes in your project under <var>\Orm\Zed\CmsBlock\Persistence</var> namespace. It’s important to make sure that they extend the base classes from the Spryker core, e.g.:
                    <ul><li><var>\Orm\Zed\CmsBlock\Persistence\SpyCmsBlockStore</var> extends <var>\Spryker\Zed\CmsBlock\Persistence\Propel\AbstractSpyCmsBlockStore</var></li><li><var>\Orm\Zed\CmsBlock\Persistence\SpyCmsBlockStoreQuery</var> extends <var>\Spryker\Zed\CmsBlock\Persistence\Propel\AbstractSpyCmsBlockStoreQuery</var></li></ul></li>
            <li>
                The newly created <var>spy_cms_block_store</var> table defines 1 row per CMS Block-store association. Populate this table according to your requirements.
                <MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot><div class="drop-anchor">Example data</div></MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><p>Assumptions</p><ul><li>You have the following CMS Blocks: Block_1, Block_2.</li><li>You have the following stores: AT, DE, US.</li></ul><p>The <var>spy_cms_block_store</var> can have a configuration like this:</p><table><tr><th>FK_CMS_BLOCK</th><th>FK_STORE</th></tr><tr><td>Block_1</td><td>AT</td></tr><tr><td>Block_1</td><td>DE</td></tr><tr><td>Block_1</td><td>US</td></tr><tr><td>Block_2</td><td>AT</td></tr></table><p>
                            This example defines "Block_1" to be enabled in all of your stores, but restricts "Block_2" to AT store only.
                        </p><p><b>IMPORTANT:</b> even if you have 1 store, the associations between CMS Blocks and stores have to be defined.</p></MadCap:dropDownBody></MadCap:dropDown><MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot><div class="drop-anchor">Example migration query</div></MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><p>To populate the new <var>spy_cms_block_store</var> table to have all CMS Blocks in all stores as an initial configuration, run the following query:</p><pre><code class="language-PHP line-numbers">
PostgreSQL:
INSERT INTO spy_cms_block_store (id_cms_block_store, fk_cms_block, fk_store)
  SELECT nextval('id_cms_block_store_pk_seq'), id_cms_block, id_store FROM spy_cms_block, spy_store;

MySQL:
INSERT INTO spy_cms_block_store (fk_cms_block, fk_store)
  SELECT id_cms_block, id_store FROM spy_cms_block, spy_store;

                        </code></pre></MadCap:dropDownBody></MadCap:dropDown></li>
            <li>
                Additionally, the following internal classes/methods have changed. Take a look if you have customized them:
                <ul><li><var>CmsBlockGlossaryManager::getCmsBlockEntity()</var></li><li><var>CmsBlockReader::findCmsBlockById()</var></li><li><var>CmsBlockQueryContainer::queryCmsBlockByIdWithTemplateWithGlossary()</var></li><li><var>CmsBlockMapper</var></li><li><var>CmsBlockWriter</var></li></ul>
                You can find more details for these changes on <a href="https://github.com/spryker/cms-block/releases">CMS Block module release page</a>.
            </li>
        </ol>
        <p>
            CMS Block is ready to be used in multi-store environment. Additionally you might want to update the <var>spryker/cms-block-gui</var> Administration Intervace to manage CMS Blocks and their store configuration.
            You can find further information about multi-store CMS Blocks here, and Zed Admin UI module migration guide <a href="mg-cms-block-gui.htm">here</a>.
</p>
        <p style="font-weight: bold;">&#160;</p>
        <p style="font-weight: bold;">See also:</p>
        <ul>
            <li><a href="mg-cms-block-collector.htm">Learn how to migrate CMS Block Collector</a>
            </li>
            <li><a href="mg-cms-block-gui.htm">Learn how to migrate CMS Block GUI</a>
            </li>
            <li>Learn more about Multi-store CMS Block</li>
            <li>Learn how to use CMS blocks</li>
        </ul>
        <p>&#160;</p>
        <p><i>Last review date: Jan. 31st, 2018 </i>
            <MadCap:conditionalText MadCap:conditions="General.Hidden Comment"><i>by Karoly Gerner </i>
            </MadCap:conditionalText>
        </p>
    </body>
</html>