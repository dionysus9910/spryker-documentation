<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="General.Demoshop,Spryker.B2C,Spryker.B2B">
    <head><title>Migration Guide - CMS</title>
    </head>
    <body>
        <h1><a name="Migration"></a>Migration Guide - CMS <img src="../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../Resources/Images/shoptype/B2C_Shop.png" /></h1>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>
                    <div class="drop-anchor">
                        <div class="drop-anchor">Upgrading from Version 4.* to Version 5.*</div>
                    </div>
                </MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>CMS version 5.0 is responsible only for CMS pages and page versioning. CMS Block functionality became more flexible and moved to CmsBlock module.</p>
                <p>If you used CMS Blocks before, you need to migrate your data to the new structure.
    If you did not use CMS Blocks in your project, you can skip the migration process.</p>
                <p>The migration process for CMS Block data is as follows:</p>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Install CMS Block module
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody>
                        <p>To install the module <var>"spryker/cms-block": "^1.0.0"</var> with Composer is required.</p>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Perform database migration
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody>
                        <ul>
                            <li> <var>`vendor/bin/console propel:diff`</var>, also manual review is necessary for the generated migration file</li>
                            <li> <var>`vendor/bin/console propel:migrate`</var></li>
                            <li> <var>`vendor/bin/console propel:model:build`</var></li>
                        </ul>
                        <p>After running the last command you’ll find some new classes in your project under <var>\Orm\Zed\Cms\Persistence</var> namespace. It’s important to make sure that they are extending the base classes from the core, i.e.
<var>`Orm\Zed\Cms\Persistence\SpyCmsBlock</var> extends <var>Spryker\Zed\CmsBlock\Persistence\Propel\AbstractSpyCmsBlock`</var><var>`Orm\Zed\Cms\Persistence\SpyCmsBlockQuery</var> extends <var>Spryker\Zed\CmsBlock\Persistence\Propel\AbstractSpyCmsBlockQuery.`</var> </p>
                        <p>The same is for <var>SpyCmsBlockGlossaryKeyMapping</var>, <var>SpyCmsBlockGlossaryKeyMappingQuery</var>, <var>SpyCmsBlockTemplate</var>, <var>SpyCmsBlockTemplateQuery</var>.</p>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Move templates
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody>
                        <p>Now your block and page templates can be found in <var>src/Pyz/Yves/Cms/Theme/default/template/*</var> or <var>src/Pyz/Shared/Cms/Theme/default/template/*</var> folders.</p>
                        <p>Move CMS Block templates to <var>src/Pyz/Shared/CmsBlock/Theme/default/template/*</var> folder.</p>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Run migration script
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody>
                        <p>For quick and smooth migration we have prepared a migration script. You can find it below.</p>
                        <MadCap:dropDown>
                            <MadCap:dropDownHead>
                                <MadCap:dropDownHotspot>
                                    <div class="drop-anchor">Click here to expand the code sample</div>
                                </MadCap:dropDownHotspot>
                            </MadCap:dropDownHead>
                            <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">
&lt;?php

/**
 * Copyright © 2016-present Spryker Systems GmbH. All rights reserved.
 * Use of this software requires acceptance of the Evaluation License Agreement. See LICENSE file.
 */

namespace Pyz\Zed\CmsBlock\Communication\Console;

use Orm\Zed\Cms\Persistence\SpyCmsPage;
use Orm\Zed\Cms\Persistence\SpyCmsPageQuery;
use Orm\Zed\Cms\Persistence\SpyCmsTemplate;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlock;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockGlossaryKeyMapping;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockGlossaryKeyMappingQuery;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockQuery;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockTemplate;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockTemplateQuery;
use Orm\Zed\CmsBlockCategoryConnector\Persistence\SpyCmsBlockCategoryConnector;
use Propel\Runtime\ActiveQuery\Criteria;
use Propel\Runtime\Propel;
use Spryker\Zed\Kernel\Communication\Console\Console;
use Spryker\Zed\Kernel\Locator;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;

/**
 * @method \Spryker\Zed\CmsBlock\Communication\CmsBlockCommunicationFactory getFactory()
 * @method \Spryker\Zed\CmsBlock\Business\CmsBlockFacade getFacade()
 */
class CmsToCmsBlockDataMigration extends Console
{

    const COMMAND_NAME = 'cms-cms-block:migrate';
    const COMMAND_DESCRIPTION = 'Migrates CMS Block data from CMS module';
    const COMMAND_ARGUMENT_DRY_RUN = 'dry-run';

    const CMS_BLOCK_RELATION_TYPE_CATEGORY = 'category';

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     *
     * @return void
     */
    public function execute(InputInterface $input, OutputInterface $output)
    {
        $connection = Propel::getConnection();

        $spyCmsBlocks = SpyCmsBlockQuery::create()
            -&gt;filterByFkPage(null, Criteria::ISNOTNULL)
            -&gt;filterByFkTemplate(null, Criteria::ISNULL)
            -&gt;find();

        $spyCmsBlocksCount = count($spyCmsBlocks);

        $output-&gt;writeln(sprintf('Processing %s blocks...', $spyCmsBlocksCount));

        foreach ($spyCmsBlocks as $spyCmsBlock) {
            $spyCmsPage = SpyCmsPageQuery::create()
                -&gt;filterByIdCmsPage($spyCmsBlock-&gt;getFkPage())
                -&gt;findOne();

            try {
                $connection-&gt;beginTransaction();

                //Migration of template
                $spyCmsTemplate = $spyCmsPage-&gt;getCmsTemplate();
                $spyCmsBlockTemplate = $this-&gt;createCmsBlockTemplate($spyCmsTemplate);
                $spyCmsBlock-&gt;setFkTemplate($spyCmsBlockTemplate-&gt;getIdCmsBlockTemplate());

                //Migration of common data fields
                $spyCmsBlock-&gt;setValidFrom($spyCmsPage-&gt;getValidFrom());
                $spyCmsBlock-&gt;setValidTo($spyCmsPage-&gt;getValidTo());
                $spyCmsBlock-&gt;setIsActive($spyCmsPage-&gt;getIsActive());

                //Migration of category relation
                if ($spyCmsBlock-&gt;getType() === self::CMS_BLOCK_RELATION_TYPE_CATEGORY) {
                    if (!$this-&gt;isCategoryConnectorInstalled()) {
                        $output-&gt;writeln('To import relation to Category you need to install CmsBlockCategoryConnector module');
                        $connection-&gt;rollBack();
                        continue;
                    }

                    $this-&gt;createCmsBlockCategoryConnector($spyCmsBlock);
                }

                $spyCmsBlock-&gt;save();
                $this-&gt;migrateGlossary($spyCmsPage, $spyCmsBlock);

                $connection-&gt;commit();
            } catch (\Exception $exception) {
                $output-&gt;writeln('ERROR: ' . $exception-&gt;getMessage());
                $connection-&gt;rollBack();
            }
        }

        $output-&gt;writeln('Successfully finished.');
    }

    /**
     * @param \Orm\Zed\Cms\Persistence\SpyCmsTemplate $spyCmsTemplate
     *
     * @return \Orm\Zed\CmsBlock\Persistence\SpyCmsBlockTemplate
     */
    protected function createCmsBlockTemplate(SpyCmsTemplate $spyCmsTemplate)
    {
        $spyCmsBlockTemplate = SpyCmsBlockTemplateQuery::create()
            -&gt;filterByTemplatePath($spyCmsTemplate-&gt;getTemplatePath())
            -&gt;findOne();

        if (empty($spyCmsBlockTemplate)) {
            $spyCmsBlockTemplate = new SpyCmsBlockTemplate();
            $spyCmsBlockTemplate-&gt;setTemplateName($spyCmsTemplate-&gt;getTemplateName());
            $spyCmsBlockTemplate-&gt;setTemplatePath($spyCmsTemplate-&gt;getTemplatePath());
            $spyCmsBlockTemplate-&gt;save();
        }

        return $spyCmsBlockTemplate;
    }

    /**
     * @param SpyCmsBlock $spyCmsBlock
     *
     * @return SpyCmsBlockCategoryConnector
     */
    protected function createCmsBlockCategoryConnector(SpyCmsBlock $spyCmsBlock)
    {
        $spyCmsBlockRelation = new SpyCmsBlockCategoryConnector();
        $spyCmsBlockRelation-&gt;setFkCmsBlock($spyCmsBlock-&gt;getIdCmsBlock());
        $spyCmsBlockRelation-&gt;setFkCategory($spyCmsBlock-&gt;getValue());
        $spyCmsBlockRelation-&gt;save();

        return $spyCmsBlockRelation;
    }

    /**
     * @param SpyCmsPage $spyCmsPage
     * @param SpyCmsBlock $spyCmsBlock
     *
     * @return void
     */
    protected function migrateGlossary(SpyCmsPage $spyCmsPage, SpyCmsBlock $spyCmsBlock)
    {
        foreach ($spyCmsPage-&gt;getSpyCmsGlossaryKeyMappings() as $cmsGlossaryKeyMapping) {
            $exists = SpyCmsBlockGlossaryKeyMappingQuery::create()
                -&gt;filterByFkCmsBlock($spyCmsBlock-&gt;getIdCmsBlock())
                -&gt;filterByPlaceholder($cmsGlossaryKeyMapping-&gt;getPlaceholder())
                -&gt;exists();

            if (!$exists) {
                $spyCmsBlockGlossaryKeyMapping = new SpyCmsBlockGlossaryKeyMapping();
                $spyCmsBlockGlossaryKeyMapping-&gt;setFkCmsBlock($spyCmsBlock-&gt;getIdCmsBlock());
                $spyCmsBlockGlossaryKeyMapping-&gt;setFkGlossaryKey($cmsGlossaryKeyMapping-&gt;getFkGlossaryKey());
                $spyCmsBlockGlossaryKeyMapping-&gt;setPlaceholder($cmsGlossaryKeyMapping-&gt;getPlaceholder());
                $spyCmsBlockGlossaryKeyMapping-&gt;save();
            }
        }

    }


    /**
     * @return void
     */
    protected function configure()
    {
        parent::configure();

        $this-&gt;setName(static::COMMAND_NAME);
        $this-&gt;setDescription(static::COMMAND_DESCRIPTION);

        $this-&gt;addOption(
            static::COMMAND_ARGUMENT_DRY_RUN,
            null,
            InputOption::VALUE_REQUIRED,
            'Run without database changes'
        );
    }

    /**
     * @return bool
     */
    protected function isCategoryConnectorInstalled()
    {
        return class_exists(SpyCmsBlockCategoryConnector::class);
    }

}
        </code></pre>
                            </MadCap:dropDownBody>
                        </MadCap:dropDown>
                        <p>Copy script to <var>src/Pyz/Zed/CmsBlock/Communication/Console/CmsToCmsBlockDataMigration.php</var> and register it in <var>Pyz\Zed\Console\ConsoleDependencyProvider</var>.</p><code class="php">
&lt;?php
namespace Pyz\Zed\Console;

class ConsoleDependencyProvider extends SprykerConsoleDependencyProvider
{
    public function getConsoleCommands(Container $container)
    {
        $commands = [
          ...
          CmsToCmsBlockDataMigration()
        ];

        ...
    }
}
</code>
                        <p>Run the script with the command <var>vendor/bin/console cms-cms-block:migrate</var>.</p>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>
                    <div class="drop-anchor">
                        <div class="drop-anchor">Upgrading from Version 3.* to Version 4.*</div>
                    </div>
                </MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>CMS Version 5.0 has a new concept for showing pages in the frontend. In previous CMS versions, after creating a CMS page and running the collectors, we were able to see the page in the frontend, but now this has changed. After creating a cms page, another step  called <var>Publish</var> is needed to display the page in the frontend. Publish aggregates all CMS related data and puts it to our new CMS table <var>spy_cms_version</var>. The new collectors push this data to the frontend storage and search.</p>
                <p class="important">Before upgrading, make sure that you do not use any deprecated code from version 3|4.*. Check the description of the deprecated code (inside the code) to see what you will need to use instead.</p>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>
                    <div class="drop-anchor">Database Migration</div>
                </MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>To start Dabase migration, run the following commands:</p>
                <ul>
                    <li><var>vendor/bin/console propel:diff</var>, manual review is necessary for the generated migration file.</li>
                    <li><var>vendor/bin/console propel:migrate</var>
                    </li>
                    <li><var>vendor/bin/console propel:model:build</var>
                    </li>
                </ul>
                <p>After running the last command, you will find some new classes in your project under the <var>\Orm\Zed\Cms\Persistence</var> namespace. It is important to make sure that they are extending the base classes from the core, i.e.</p>
                <ul>
                    <li><var>Orm\Zed\Cms\Persistence\SpyCmsVersion</var> extends <var>Spryker\Zed\Cms\Persistence\Propel\SpyCmsVersion</var>,</li>
                    <li><var>Orm\Zed\Cms\Persistence\SpyCmsVersionQuery</var> extends <var>Spryker\Zed\Cms\Persistence\Propel\SpyCmsVersionQuery</var></li>
                </ul>
                <h3>CMS Templates</h3>
                <p>In this version we have moved all CMS templates to the <var>Shared </var>layer instead of only <var>Yves</var>, but you are still able to use the old files.</p>
                <p><var>src/Pyz/Yves/Cms/Theme/default/template/* </var>=&gt; <var>src/Pyz/Shared/Cms/Theme/default/template/*</var></p>
                <h3>CMS Twig Functions</h3>
                <p>The <var>TwigCms </var>function has been improved to provide better speed and performance, it will only send query to Redis when the translations are not available. </p>
                <p>You can still work with the current version although upgrading is highly recommended.</p>
                <p>You can find it here: <var>src/Pyz/Yves/Cms/Plugin/TwigCms.php</var></p>
                <h3>CMS Collector</h3>
                <p>To push new CMS version data to the frontend storage and search, add it to <var>src/Pyz/Zed/Collector/CollectorDependencyProvider.php </var>plugin stack:</p>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Click to expand the code sample
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">    &lt;?php
    ...
    
    use Spryker\Zed\CmsCollector\Communication\Plugin\CmsVersionPageCollectorSearchPlugin;
    use Spryker\Zed\CmsCollector\Communication\Plugin\CmsVersionPageCollectorStoragePlugin;
    
    class CollectorDependencyProvider extends SprykerCollectorDependencyProvider
    {
    ...
        $container[self::SEARCH_PLUGINS] = function (Container $container) {
          return [
              ...
              CmsConstants::RESOURCE_TYPE_PAGE =&gt; new CmsVersionPageCollectorSearchPlugin(),
          ];
        };
          
          ...
          
        $container[self::STORAGE_PLUGINS] = function (Container $container) {
           return [
                ...
                CmsConstants::RESOURCE_TYPE_PAGE =&gt; new CmsVersionPageCollectorStoragePlugin(),
                ...
           ];
    };
    
    ...
    ?&gt;
</code></pre>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
                <h3>CMS User Interaction</h3>
                <p>When a CMS page is published, we also store/show user information for this action. To store and show user information, register two new plugins from the new <var>CmsUserConnector </var>module.</p>
                <p>Add them here: <var>src/Pyz/Zed/Cms/CmsDependencyProvider.php</var></p>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Click to expand the code sample
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php
namespace Pyz\Zed\Cms;

use Spryker\Zed\Cms\CmsDependencyProvider as SprykerCmsDependencyProvider;
use Spryker\Zed\CmsUserConnector\Communication\Plugin\UserCmsVersionPostSavePlugin;
use Spryker\Zed\CmsUserConnector\Communication\Plugin\UserCmsVersionTransferExpanderPlugin;
use Spryker\Zed\Kernel\Container;

class CmsDependencyProvider extends SprykerCmsDependencyProvider
{

    protected function getPostSavePlugins(Container $container)
    {
        return [
            new UserCmsVersionPostSavePlugin()
        ];
    }

    protected function getTransferExpanderPlugins(Container $container)
    {
        return [
            new UserCmsVersionTransferExpanderPlugin()
        ];
    }
}
?&gt;</code></pre>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
                <h3>CMS Data Importer</h3>
                <p>To publish pages after importing, add this into your CMS Importer class:</p>
                <MadCap:dropDown>
                    <MadCap:dropDownHead>
                        <MadCap:dropDownHotspot>
                            Click to expand the code sample
                        </MadCap:dropDownHotspot>
                    </MadCap:dropDownHead>
                    <MadCap:dropDownBody><pre><code class="language-PHP line-numbers">    &lt;?php
    
    /**
     * @param array $data
     *
     * @return void
     */
    protected function importOne(array $data)
    {
        $page = $this-&gt;format($data);
        $templateTransfer = $this-&gt;findOrCreateTemplate($page[self::TEMPLATE]);

        $pageTransfer = $this-&gt;createPage($templateTransfer, $page);

        foreach ($this-&gt;localeFacade-&gt;getLocaleCollection() as $locale =&gt; $localeTransfer) {
            $urlTransfer = new UrlTransfer();
            $urlTransfer-&gt;setUrl($page[self::LOCALES][$locale][self::URL]);

            if ($this-&gt;urlFacade-&gt;hasUrl($urlTransfer)) {
                return;
            }

            $placeholders = $page[self::LOCALES][$locale][self::PLACEHOLDERS];

            $this-&gt;createPageUrl($pageTransfer, $urlTransfer-&gt;getUrl(), $localeTransfer);
            $this-&gt;createPlaceholder($placeholders, $pageTransfer, $localeTransfer);
        }

        $this-&gt;cmsFacade-&gt;publishWithVersion($pageTransfer-&gt;getIdCmsPage()); // Publishing the pages
    }
    ?&gt;    </code></pre>
                    </MadCap:dropDownBody>
                </MadCap:dropDown>
                <h3>Publishing Current Pages</h3>
                <p>To publish current pages, create a console command that calls the following method:</p><pre><code class="language-PHP line-numbers">    &lt;?php
    
    protected function publishAllPages()
    {
        $spyCmsPagesEntities = SpyCmsPageQuery::create()-&gt;find();

        foreach ($spyCmsPagesEntities as $spyCmsPagesEntity) {
            $this-&gt;cmsFacade-&gt;publishWithVersion($spyCmsPagesEntity-&gt;getIdCmsPage());
        }
    ?&gt;
    </code></pre>
                <hr class="noteInDiv" />
                <h2>Upgrading from Version 2.* to Version 3.*</h2>
                <p>We have extended CMS pages with localized attributes such as name and HTML meta header information. Also CMS pages can now be marked as searchable. These changes required some changes in the database.</p>
                <ol>
                    <li>Before upgrading to the new version, make sure that you do not use any deprecated code from version 2.*. Check the description of the deprecated code to see what you will need to use instead.</li>
                    <li>Database migration<ol><li><var>vendor/bin/console propel:diff</var>, also manual review is necessary for the generated migration file.</li><li><var>vendor/bin/console propel:migrate</var></li><li><var>vendor/bin/console propel:model:build</var></li><li>After running the last command you’ll find some new classes in your project under <var>\Orm\Zed\Cms\Persistence</var> namespace. It’s important to make sure that they are extending the base classes from the core, i.e.<ul style="list-style-type: circle;"><li class="bullet_list"><var>Orm\Zed\Cms\Persistence\SpyCmsPageLocalizedAttributes extends Spryker\Zed\Cms\Persistence\Propel\AbstractSpyCmsPageLocalizedAttributes,</var></li><li class="bullet_list"><var>Orm\Zed\Cms\Persistence\SpyCmsPageLocalizedAttributesQuery</var> extends <var>Spryker\Zed\Cms\Persistence\Propel\AbstractSpyCmsPageLocalizedAttributesQuery</var>.</li></ul></li></ol></li>
                </ol>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <p><b>See also:</b>
        </p>
        <ul>
            <li><a href="../Administration Interface Guide/CMS/bg_cms.htm">Learn how to use CMS</a>
            </li>
            <li><a href="mg-cms-block.htm">Learn how to migrate CMS Block</a>
            </li>
            <li><a href="mg-cms-block-gui.htm">Learn how to migrate CMS Block GUI</a>
            </li>
            <li><a href="mg-cms-block-collector.htm">Learn how to migrate CMS Block Collector</a>
            </li>
            <li><a href="mg-cms-block-category-connector-console.htm">Learn how to migrate CMS Block Category Connector</a>
            </li>
            <li><a href="mg-cms-collector.htm">Learn how to migrate CMS Collector</a>
            </li>
        </ul>
        <p>&#160;</p>
    </body>
</html>