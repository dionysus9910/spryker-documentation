<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="General.Demoshop,Spryker.B2B,Spryker.B2C">
    <head>
    </head>
    <body>
        <h1>Migration Guide - Tax <img src="../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../Resources/Images/shoptype/B2C_Shop.png" /></h1>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot><div class="drop-anchor">Upgrading from Version 4.* to Version 5.*</div></MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>In version 5, tax calculation logic changed, tax amount for options, expenses and items are now calculated in the Tax module. </p>
                <p>The plugins: <var>ExpenseTaxCalculatorPlugin</var>, <var>ItemTaxCalculatorPlugin</var> and <var>TaxTotalsCalculatorPlugin</var> were removed, and replaced with:</p>
                <ul>
                    <li><var>TaxAmountCalculatorPlugin</var> - to calculate item, item product option and expense taxes. </li>
                    <li><var>TaxAmountAfterCancellationCalculatorPlugin</var> - to calculate tax amount after cancellation/refund happened.</li>
                </ul>
                <p>Corresponding plugin business classes, <var>ExpenseTaxCalculator</var>, <var>ItemTaxCalculator</var>, <var>TaxCalculation</var> were also removed and replaced with:</p>
                <ul>
                    <li><var>Business classes TaxAmountCalculator </var>
                    </li>
                    <li><var>TaxAmountAfterCancellationCalculator</var> </li>
                </ul>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot><div class="drop-anchor">Upgrading from version 2.* to version 3.*</div></MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>If you’re migrating the Tax module from version 2 to version 3, you need to follow the steps described below.</p>
                <p>With the version 3 of the Tax module, new tax calculation is used. The tax rate is based on the current shipping country or, if it’s unavailable, a default tax rate value is used.</p>
                <p>First you need to execute a database schema migration:</p><pre><code class="language-PHP line-numbers">ALTER TABLE "spy_tax_rate"
ADD "fk_country" INTEGER;
ALTER TABLE "spy_tax_rate" ADD CONSTRAINT "spy_tax_rate-fk_country"
   FOREIGN KEY ("fk_country")
   REFERENCES "spy_country" ("id_country");

ALTER TABLE "spy_tax_rate"
 ADD "created_at" TIMESTAMP,
 ADD "updated_at" TIMESTAMP;

ALTER TABLE "spy_tax_set"
 ADD "created_at" TIMESTAMP,
 ADD "updated_at" TIMESTAMP;</code></pre>
                <p>Now you should be able edit the tax rates in Zed, under the tax section.</p>
                <p>To use the new tax rate calculation logic, you need to register the tax calculator plugins in <var>CalculationDependencyProvider::getCalculatorStack()</var>:</p>
                <ul>
                    <li class="bullet_list"><var>ItemTaxCalculatorPlugin</var> - used after item sum gross amounts are calculated.</li>
                    <li class="bullet_list"><var>ShipmentTaxRateCalculatorPlugin</var> - used after expense gross sum amount is calculated.</li>
                    <li class="bullet_list"><var>ProductOptionTaxRateCalculatorPlugin</var> - used after item sum gross amounts are calculated.</li>
                    <li class="bullet_list"><var>ProductItemTaxRateCalculatorPlugin</var> - used after item sum gross amounts are calculated.</li>
                    <li class="bullet_list"><var>ExpenseTaxCalculatorPlugin</var> - used after expense gross sum amount is calculated.</li>
                </ul>
                <p>If you have discounts:</p>
                <ul>
                    <li class="bullet_list"><var>ItemsWithProductOptionsAndDiscountsGrossPriceCalculatorPlugin()</var> - after <var>SumGrossCalculatedDiscountAmountCalculatorPlugin</var>.</li>
                    <li class="bullet_list"><var>ItemsWithProductOptionsAndDiscountsTaxCalculatorPlugin()</var> - after <var>ItemsWithProductOptionsAndDiscountsGrossPriceCalculatorPlugin</var>.</li>
                    <li class="bullet_list"><var>DiscountTotalsWithProductOptionsCalculatorPlugin</var> - after <var>DiscountTotalsCalculatorPlugin</var>.</li>
                    <li class="bullet_list"><var>ExpenseTaxWithDiscountsCalculatorPlugin</var> - after <var>DiscountTotalsWithProductOptionsCalculatorPlugin</var>.</li>
                    <li class="bullet_list"><var>TaxTotalAmountWithProductOptionsAndDiscountsCalculatorPlugin</var> - after <var>TaxTotalsCalculatorPlugin</var>.</li>
                </ul>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <p>&#160;</p>
        <p><b>See also:</b>
        </p>
        <ul>
            <li>Get a general idea about Tax Module</li>
        </ul>
    </body>
</html>