<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:conditions="General.Demoshop,Spryker.B2B,Spryker.B2C,Spryker.DemoShop,Spryker.ShopSuite">
    <head>
    </head>
    <body>
        <h1>Migration Guide - Payment <img src="../Resources/Images/shoptype/B2B_Shop.png" /> <img src="../Resources/Images/shoptype/B2C_Shop.png" /> <img src="../Resources/Images/shoptype/MasterSuite.png" /> <img src="../Resources/Images/shoptype/Demoshop.png" /></h1>
        <h2>Upgrading from Version 3.* to Version 4.*
</h2>
        <p>In the Payment module version 4 we have added new payment tables to store order payment related information.</p>
        <p>To enable the new version:</p>
        <ol>
            <li>Composer update spryker/payment to new version
</li>
            <li> Run <var>vendor/bin/console transfer:generate</var> to generate new transfer objects
</li>
            <li>Insert new sales payment tables by executing the following queries:</li>
        </ol><pre><code class="language-PHP line-numbers">
CREATE SEQUENCE “spy_sales_payment_pk_seq”;
CREATE TABLE “spy_sales_payment”
(
    “id_sales_payment” INTEGER NOT NULL,
    “fk_sales_order” INTEGER NOT NULL,
    “fk_sales_payment_method_type” INTEGER NOT NULL,
    “amount” INTEGER NOT NULL,
    “created_at” TIMESTAMP,
    “updated_at” TIMESTAMP,
    PRIMARY KEY (“id_sales_payment”)
);
CREATE SEQUENCE “spy_sales_payment_method_type_pk_seq”;
CREATE TABLE “spy_sales_payment_method_type”
(
    “id_sales_payment_method_type” INTEGER NOT NULL,
    “payment_provider” VARCHAR NOT NULL,
    “payment_method” VARCHAR NOT NULL,
    PRIMARY KEY (“id_sales_payment_method_type”)
);
CREATE INDEX “spy_sales_payment_method_type-type” ON “spy_sales_payment_method_type” (“payment_provider”,“payment_method”);
ALTER TABLE “spy_sales_payment” ADD CONSTRAINT “spy_sales_payment-fk_sales_order”
    FOREIGN KEY (“fk_sales_order”)
    REFERENCES “spy_sales_order” (“id_sales_order”);
ALTER TABLE “spy_sales_payment” ADD CONSTRAINT “spy_sales_payment-fk_sales_payment_method_type”
    FOREIGN KEY (“fk_sales_payment_method_type”)
    REFERENCES “spy_sales_payment_method_type” (“id_sales_payment_method_type”);
</code></pre>
        <p>You should now be able to see that the new order saved payment information into the <var>spy_sales_payment</var> table.
</p>
        <p>You may also want to enable the new plugin <var>\Spryker\Zed\Payment\Communication\Plugin\Sales\PaymentOrderHydratePlugin</var> by adding it to <var>\Pyz\Zed\Sales\SalesDependencyProvider::getOrderHydrationPlugins</var>.
</p>
        <p>This enables new payment provider hydration plugins which are hydrated to OrderTransfer. </p>
        <p>&#160;</p>
        <p><b>See also:</b>
        </p>
        <ul>
            <li>Learn more about Payment module</li>
        </ul>
    </body>
</html>