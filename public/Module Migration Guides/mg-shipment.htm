<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" style="" MadCap:conditions="General.Demoshop">
    <head>
    </head>
    <body>
        <h1>Migration Guide - Shipment</h1>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>
                    <div class="drop-anchor">Upgrading from Version 5.* to Version 6.*</div>
                </MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>In version 6, multi-currency prices are introduced for shipment methods, allowing to set up different net and gross price per shipment method for each preconfigured currency.</p>
                <p>The <var>spy_shipment_method.default_price</var> database column becomes deprecated. Shipment method prices are stored in <var>spy_shipment_method_price</var> database table instead. <var>spy_shipment_method_price</var> database table holds a store + currency specific gross and net price for each shipment method.</p>
       Database structure is as follows:
                <img src="../Resources/Images/shipment_method_price_database_schema.png" /><ol><li>
                Update <var>spryker/shipment</var> module to at least 6.0.0 version.
            </li><li>Update database
                <ul><li>Install the database changes by running <var>vendor/bin/console propel:diff</var>. Propel should generate a migration file with the changes.</li><li>Apply the database changes: <var>vendor/bin/console propel:migrate</var>.</li><li>Generate and update ORM models: <var>vendor/bin/console propel:model:build</var>.</li><li>
                        You will find some new classes in your project under <var>\Orm\Zed\Shipment\Persistence</var> namespace. It’s important that you make sure that they extend the base classes from the Spryker core, e.g.:
                        <ul><li><var>\Orm\Zed\Shipment\Persistence\SpyShipmentMethodPrice</var> extends <var>\Spryker\Zed\Shipment\Persistence\Propel\AbstractSpyShipmentMethodPrice</var></li><li><var>\Orm\Zed\Shipment\Persistence\SpyShipmentMethodPriceQuery</var> extends <var>\Spryker\Zed\Shipment\Persistence\Propel\AbstractSpyShipmentMethodPriceQuery</var></li></ul></li></ul></li><li><p>Run <var>vendor/bin/console transfer:generate</var> to update and generate transfer object changes.</p><MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot>Transfer object changes</MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><p>Property <var>defaultPrice</var> in <var>ShipmentMethod</var> transfer object is replaced by <var>prices</var>, and <var>storeCurrencyPrice</var> properties.</p><ul><li><var>prices</var> transfer object property contains the shipment method related prices from <var>spy_shipment_method_price</var> database table as a <var>MoneyValue</var> transfer object collection.</li><li><var>storeCurrencyPrice</var> transfer object property contains 1 specific price, based on the preconfigured store + price mode and for the requested currency.</li></ul><p><var>ShipmentMethod</var> transfer object now contains a <var>shipmentMethodKey</var> property, accordingly to the new database structure.</p></MadCap:dropDownBody></MadCap:dropDown></li><li>Replace the usages of <var>ShipmentMethod.defaultPrice</var> transfer object property in your custom codes, depending on your requirements.</li><li><p>Migrate your old database structure by creating a <var>spy_shipment_method_price</var> row for each of your  <var>spy_shipment_method</var> rows. </p><p>The number of the <var>spy_shipment_method_price</var> rows per shipment method should match the number of store and currency pair set up in the configuration.</p><p>Depending on your requirements, you can set gross/net prices as <var>0</var>/<var>null</var>/<var>any integer value as cents</var>.</p><MadCap:dropDown><MadCap:dropDownHead><MadCap:dropDownHotspot>Example: Migration</MadCap:dropDownHotspot></MadCap:dropDownHead><MadCap:dropDownBody><pre><code class="language-PHP line-numbers">&lt;?php

/**
 * Copyright © 2016-present Spryker Systems GmbH. All rights reserved.
 * Use of this software requires acceptance of the Evaluation License Agreement. See LICENSE file.
 */

namespace Spryker\Zed\Shipment\Communication\Console;

use Orm\Zed\Shipment\Persistence\SpyShipmentMethod;
use Orm\Zed\Shipment\Persistence\SpyShipmentMethodPrice;
use Orm\Zed\Shipment\Persistence\SpyShipmentMethodPriceQuery;
use Orm\Zed\Shipment\Persistence\SpyShipmentMethodQuery;
use Spryker\Zed\Kernel\Communication\Console\Console;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Question\ConfirmationQuestion;

/**
 * @method \Spryker\Zed\Shipment\Communication\ShipmentCommunicationFactory getFactory()
 */
class MigrateShipmentMethodPricesConsole extends Console
{

    const COMMAND_NAME = 'shipment:price:migrate';
    const COMMAND_DESCRIPTION = 'Console command to migrate shipment prices to multi currency implementation.';

    /**
     * @var int[] Keys are currency iso codes, values are currency ids.
     */
    protected static $idCurrencyCache = [];

    /**
     * @return void
     */
    protected function configure()
    {
        $this-&gt;setName(static::COMMAND_NAME);
        $this-&gt;setDescription(static::COMMAND_DESCRIPTION);

        parent::configure();
    }

    /**
     * @param \Symfony\Component\Console\Input\InputInterface $input
     * @param \Symfony\Component\Console\Output\OutputInterface $output
     *
     * @return void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $storeTransferCollection = $this-&gt;getFactory()-&gt;getStoreFacade()-&gt;getAllStores();
        $shipmentMethodCollection = SpyShipmentMethodQuery::create()-&gt;find();

        if (count($shipmentMethodCollection) === 0) {
            $output-&gt;writeln('There are no shipment methods to migrate.');
            return;
        }
        if (count($storeTransferCollection) === 0) {
            $output-&gt;writeln('There are no stores set up to migrate.');
            return;
        }

        $question = new ConfirmationQuestion(
            sprintf('Migrate %s shipment methods? (y|n)', count($shipmentMethodCollection)),
            false
        );

        if (!$this-&gt;getQuestionHelper()-&gt;ask($input, $output, $question)) {
            $output-&gt;writeln('Aborted.');
            return;
        }

        $storeCurrencies = $this-&gt;getStoreCurrencies($storeTransferCollection);
        $defaultIdStore = $this-&gt;getDefaultIdStore();
        $defaultIdCurrency = $this-&gt;getDefaultIdCurrency();

        foreach ($shipmentMethodCollection as $shipmentMethodEntity) {
            $this-&gt;processShipmentMethod($shipmentMethodEntity, $storeCurrencies, $defaultIdStore, $defaultIdCurrency);

            $output-&gt;writeln(sprintf('Shipment method %d is migrated.', $shipmentMethodEntity-&gt;getIdShipmentMethod()));
        }

        $output-&gt;writeln('done.');
    }

    /**
     * @param \Orm\Zed\Shipment\Persistence\SpyShipmentMethod $shipmentMethodEntity
     * @param array $storeCurrencies
     * @param int $defaultIdStore
     * @param int $defaultIdCurrency
     *
     * @return void
     */
    protected function processShipmentMethod(SpyShipmentMethod $shipmentMethodEntity, array $storeCurrencies, $defaultIdStore, $defaultIdCurrency)
    {
        foreach ($storeCurrencies as list($idStore, $idCurrency)) {
            $shipmentMethodPriceEntity = SpyShipmentMethodPriceQuery::create()
                -&gt;filterByFkShipmentMethod($shipmentMethodEntity-&gt;getIdShipmentMethod())
                -&gt;filterByFkStore($idStore)
                -&gt;filterByFkCurrency($idCurrency)
                -&gt;findOneOrCreate();

            $isDefaultStoreCurrency = $idStore === $defaultIdStore &amp;&amp; $idCurrency === $defaultIdCurrency;

            $this-&gt;setNetPrice($shipmentMethodPriceEntity);
            $this-&gt;setGrossPrice($shipmentMethodPriceEntity, $shipmentMethodEntity, $isDefaultStoreCurrency);

            $shipmentMethodPriceEntity-&gt;save();
        }
    }

    /**
     * @param \Orm\Zed\Shipment\Persistence\SpyShipmentMethodPrice $shipmentMethodPrice
     *
     * @return void
     */
    protected function setNetPrice(SpyShipmentMethodPrice $shipmentMethodPrice)
    {
        if ($shipmentMethodPrice-&gt;getDefaultNetPrice() !== null) {
            return;
        }

        $shipmentMethodPrice-&gt;setDefaultNetPrice(0);
    }

    /**
     * @param \Orm\Zed\Shipment\Persistence\SpyShipmentMethodPrice $shipmentMethodPrice
     * @param \Orm\Zed\Shipment\Persistence\SpyShipmentMethod $shipmentMethod
     * @param bool $isDefaultStoreCurrency
     *
     * @return void
     */
    protected function setGrossPrice(SpyShipmentMethodPrice $shipmentMethodPrice, SpyShipmentMethod $shipmentMethod, $isDefaultStoreCurrency)
    {
        if ($shipmentMethodPrice-&gt;getDefaultGrossPrice() !== null) {
            return;
        }

        $shipmentMethodPrice-&gt;setDefaultGrossPrice($isDefaultStoreCurrency ? (int)$shipmentMethod-&gt;getDefaultPrice() : 0);
    }

    /**
     * Returns with a list of available store-currency id pairs.
     *
     * Example:
     *   Store 1 has currency 5, 6
     *   Store 2 has currency 10
     *   Result: [
     *              [1, 5],
     *              [1, 6],
     *              [2, 10]
     *           ]
     *
     * @param \Generated\Shared\Transfer\StoreTransfer[] $storeTransferCollection
     *
     * @return array
     */
    protected function getStoreCurrencies(array $storeTransferCollection)
    {
        $currencies = [];

        foreach ($storeTransferCollection as $storeTransfer) {
            foreach ($storeTransfer-&gt;getAvailableCurrencyIsoCodes() as $isoCode) {
                $currencies[] = [$storeTransfer-&gt;getIdStore(), $this-&gt;getIdCurrencyByIsoCode($isoCode)];
            }
        }

        return $currencies;
    }

    /**
     * @param string $currencyIsoCode
     *
     * @return int
     */
    protected function getIdCurrencyByIsoCode($currencyIsoCode)
    {
        if (!isset(static::$idCurrencyCache[$currencyIsoCode])) {
            static::$idCurrencyCache[$currencyIsoCode] = $this-&gt;getFactory()
                -&gt;getCurrencyFacade()
                -&gt;fromIsoCode($currencyIsoCode)
                -&gt;getIdCurrency();
        }

        return static::$idCurrencyCache[$currencyIsoCode];
    }

    /**
     * @return int
     */
    protected function getDefaultIdCurrency()
    {
        return $this-&gt;getIdCurrencyByIsoCode(
            $this-&gt;getFactory()
                -&gt;getStoreFacade()
                -&gt;getCurrentStore()
                -&gt;getDefaultCurrencyIsoCode()
        );
    }

    /**
     * @return int
     */
    protected function getDefaultIdStore()
    {
        return $this-&gt;getFactory()-&gt;getStoreFacade()-&gt;getCurrentStore()-&gt;getIdStore();
    }

    /**
     * @return \Symfony\Component\Console\Helper\QuestionHelper
     */
    protected function getQuestionHelper()
    {
        return $this-&gt;getHelper('question');
    }

}

                            </code></pre></MadCap:dropDownBody></MadCap:dropDown></li><li>
                Register the prepared multi-currency handling <var>MoneyCollectFormType</var> form type in your project.
                Here is the example of MoneyCollectionTypePlugin registration:<pre><code class="language-PHP line-numbers">&lt;?php
namespace Pyz\Zed\Shipment;

use Spryker\Zed\Kernel\Container;
use Spryker\Zed\Money\Communication\Plugin\Form\MoneyCollectionFormTypePlugin;
use Spryker\Zed\Shipment\ShipmentDependencyProvider as SprykerShipmentDependencyProvider;

class ShipmentDependencyProvider extends SprykerShipmentDependencyProvider
{
    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Kernel\Communication\Form\FormTypeInterface
     */
    protected function createMoneyCollectionFormTypePlugin(Container $container)
    {
        return new MoneyCollectionFormTypePlugin();
    }
}
                        </code></pre></li><li><var>ShipmentFacadeInterface::createMethod</var> method now expects "prices" <var>MoneyValue</var> transfer object collection to be set in the provided <var>ShipmentMethod</var> transfer object.
                Update your custom calls to this method accordingly.
            </li><li><var>ShipmentFacadeInterface::updateMethod</var> method now expects "prices" <var>MoneyValue</var> transfer object collection to be set in the provided <var>ShipmentMethod</var> transfer object.
                Update your custom calls to this method accordingly.
            </li><li><p><var>ShipmentFacadeInterface::getAvailableMethods</var> method applies multi-currency feature:</p><ol><li>Does not populate <var>taxRate</var> transfer object property anymore in <var>shipment method</var> transfer objects.</li><li>Excludes shipment methods which would end up with <var>NULL</var> value for the request's <var>currency</var> and preconfigured store + price mode.</li></ol><p>Amend your custom calls to <var>ShipmentFacadeInterface::getAvailableMethods</var> method accordingly to your requirements.</p><p><b>Important:</b> <var>CheckoutAvailableShipmentMethodsPlugin</var> is an adapter to <var>ShipmentFacadeInterface::getAvailableMethods</var>. If you use this plugin, you will need to amend its usage in your code.</p></li><li><var>MethodForm::setDefaultOptions</var> deprecated method was removed, use <var>MethodForm::configureOptions</var> instead.
            </li><li><var>ShipmentDependencyProvider::STORE</var> static dependency access was replaced with proper <var>StoreFacadeInterface</var> bridged access. Amend your implementation if you have customized it.
            </li><li>Note: <var>MethodForm.defaultPrice</var> form field was replaced with its multi-currency representation. Amend your implementation if you have customized it.</li><li>Note: <var>MethodForm</var> form now works on <var>ShipmentMethod</var> transfer object instead of simple array. Amend your implementation if you have customized it.</li><li>
                Note: <var>ShipmentMethodDeliveryTimePluginInterface</var> interface now expects the returned delivery time in seconds. Amend your implementations of this plugin accordingly.
                DemoShop example implementation of the plugin and its usage in <var>ShipmentFormDataProvider::getDeliveryTime</var> method are also updated.
            </li></ol><p>Go to Shipment management Zed Admin UI to verify your shipment method prices.</p></MadCap:dropDownBody>
        </MadCap:dropDown>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>
                    <div class="drop-anchor">Upgrading from Version 4.* to Version 5.*</div>
                </MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>In version 5, shipment lost the direct foreign key <var>sales.fk_shipment_method</var> to the <var>sales_order</var> table, it was replaced with the <var>spy_sales_shipment</var> table where all shipment information is stored.</p>
                <p>A new <var>SalesOrderHydration </var>plugin was added to populate <var>OrderTransfer</var> with shipment information <var>ShipmentOrderHydratePlugin</var>.</p>
                <p>The new shipment table structure requires manual data migration, we have provided migration script, you can read how to migrate shipment data in <a href="mg-sales.htm">sales migration guide</a>.</p>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <MadCap:dropDown>
            <MadCap:dropDownHead>
                <MadCap:dropDownHotspot>
                    <div class="drop-anchor">Upgrading from Version 2.* to Version 3.*</div>
                </MadCap:dropDownHotspot>
            </MadCap:dropDownHead>
            <MadCap:dropDownBody>
                <p>The tax plugins are using the version 3.* of the Tax module. You need to upgrade the <a href="mg-tax.htm">Tax </a>module.</p>
            </MadCap:dropDownBody>
        </MadCap:dropDown>
        <p>&#160;</p>
        <p><b>See also:</b>
        </p>
        <ul>
            <li>Get acquainted with Shipment</li>
            <li><a href="../Developing with Spryker/Module Guide/Shipment/shipment_overview.htm">Learn more about Shipment concepts</a>
            </li>
            <li>Learn more about Shipment Methods Plugins</li>
        </ul>
        <p>&#160;</p>
        <p><i>Last review date: Oct. 16th, 2017 </i>
            <MadCap:conditionalText MadCap:conditions="General.Hidden Comment"><i>by Karoly Gerner</i>
            </MadCap:conditionalText>
        </p>
    </body>
</html>